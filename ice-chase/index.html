<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>ICE CHASE — UFCR Games</title>
  <link rel="icon" href="../assets/images/shield-logo.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Oswald:wght@500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    :root{--orange:#FA4616;--gold:#F0A830;--navy:#001845;--dark:#0A0E1A;--red:#D32F2F;--green:#43A047;--blue:#2558a0;--font-body:'Inter',sans-serif;--font-heading:'Oswald',sans-serif}
    *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
    html,body{width:100%;height:100%;overflow:hidden;font-family:var(--font-body);background:#111;color:#fff;-webkit-tap-highlight-color:transparent;user-select:none;touch-action:none}
    .nav{position:fixed;top:0;left:0;right:0;z-index:100;height:44px;background:rgba(0,24,69,.95);backdrop-filter:blur(20px);border-bottom:1px solid rgba(255,255,255,.06);display:flex;align-items:center;justify-content:space-between;padding:0 12px}
    .nav-logo{display:flex;align-items:center;gap:6px;text-decoration:none;color:#fff}
    .nav-logo img{height:26px;border-radius:3px;background:#fff;padding:1px}
    .nav-logo span{font-family:var(--font-heading);font-size:.95rem;font-weight:700;letter-spacing:.08em}
    .nav-back{font-size:.65rem;color:rgba(255,255,255,.5);text-decoration:none;letter-spacing:.1em;text-transform:uppercase;font-weight:600}
    .hud{position:fixed;top:44px;left:0;right:0;z-index:90;display:flex;justify-content:space-between;padding:6px 16px;background:rgba(0,24,69,.7);backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,255,255,.05)}
    .hud-item{text-align:center;flex:1}
    .hud-label{font-size:.5rem;text-transform:uppercase;letter-spacing:.15em;color:rgba(255,255,255,.3)}
    .hud-value{font-family:var(--font-heading);font-size:1.1rem;font-weight:700}
    .hud-value.score{color:var(--gold)}.hud-value.spd{color:var(--green)}.hud-value.dist{color:var(--orange)}.hud-value.busts{color:var(--blue)}
    canvas{position:fixed;top:0;left:0;width:100%;height:100%;display:block}
    .screen-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(5,8,18,.94);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:200;padding:24px;text-align:center}
    .screen-overlay.hidden{display:none}
    .screen-title{font-family:var(--font-heading);font-size:clamp(2.2rem,8vw,4rem);font-weight:700;text-transform:uppercase;letter-spacing:.04em;margin-bottom:6px}
    .screen-sub{font-size:.9rem;color:rgba(255,255,255,.45);margin-bottom:24px;max-width:380px;line-height:1.6}
    .screen-stats{margin-bottom:24px;min-width:220px}
    .stat-row{display:flex;justify-content:space-between;font-size:.9rem;padding:5px 0;border-bottom:1px solid rgba(255,255,255,.05)}
    .stat-label{color:rgba(255,255,255,.35)}.stat-val{font-weight:700;color:var(--gold)}
    .level-badge{font-family:var(--font-heading);font-size:.65rem;font-weight:600;letter-spacing:.2em;text-transform:uppercase;color:var(--gold);margin-bottom:6px}
    .btn{font-family:var(--font-heading);font-size:1rem;font-weight:600;letter-spacing:.12em;text-transform:uppercase;background:var(--orange);color:#fff;border:none;padding:12px 32px;cursor:pointer;transition:all .3s}
    .btn:hover{background:#e03a0e;transform:translateY(-2px)}
    .share-btns{display:flex;gap:10px;margin-top:12px}
    .share-btn{font-family:var(--font-heading);font-size:.65rem;font-weight:600;letter-spacing:.1em;text-transform:uppercase;padding:8px 14px;border:1px solid rgba(255,255,255,.12);background:transparent;color:#fff;cursor:pointer;display:flex;align-items:center;gap:5px;transition:all .3s}
    .share-btn:hover{background:rgba(255,255,255,.06)}
    .how-to{max-width:360px;margin-bottom:20px;text-align:left}
    .how-to li{font-size:.82rem;color:rgba(255,255,255,.5);margin-bottom:5px;line-height:1.5;list-style:none;padding-left:18px;position:relative}
    .how-to li::before{content:'';position:absolute;left:0;top:7px;width:6px;height:6px;background:var(--orange);border-radius:50%}
  </style>
</head>
<body>

<nav class="nav">
  <a href="../" class="nav-logo"><img src="../assets/images/shield-logo.png" alt="UFCR"><span>UFCR</span></a>
  <a href="../games/" class="nav-back"><i class="fas fa-arrow-left"></i> Games</a>
</nav>

<div class="hud" id="hud" style="display:none">
  <div class="hud-item"><div class="hud-label">Score</div><div class="hud-value score" id="hudScore">0</div></div>
  <div class="hud-item"><div class="hud-label">Busts</div><div class="hud-value busts" id="hudBusts">0</div></div>
  <div class="hud-item"><div class="hud-label">Speed</div><div class="hud-value spd" id="hudSpeed">0</div></div>
  <div class="hud-item"><div class="hud-label">Gap</div><div class="hud-value dist" id="hudDist">---</div></div>
</div>

<div class="screen-overlay" id="startScreen">
  <div class="level-badge">UFCR GAMES</div>
  <div class="screen-title" style="color:var(--orange)">ICE CHASE</div>
  <p class="screen-sub">High-speed pursuit through city streets. Chase down the suspect's vehicle and ram them off the road.</p>
  <ul class="how-to">
    <li><strong>Left / Right</strong> arrow keys or <strong>A / D</strong> to steer</li>
    <li><strong>Up</strong> or <strong>W</strong> to accelerate</li>
    <li><strong>Down</strong> or <strong>S</strong> to brake</li>
    <li>On mobile: <strong>tilt phone</strong> or <strong>touch left/right</strong> side of screen</li>
    <li>Ram the red suspect car to bust them</li>
    <li>Dodge civilian cars — crashing costs speed</li>
    <li>Don't let the suspect get too far ahead</li>
  </ul>
  <button class="btn" id="startBtn">Start Chase</button>
</div>

<div class="screen-overlay hidden" id="gameOverScreen">
  <div class="level-badge">PURSUIT ENDED</div>
  <div class="screen-title" id="goTitle" style="color:var(--red)">Escaped</div>
  <p class="screen-sub" id="goSub"></p>
  <div class="screen-stats" id="goStats"></div>
  <button class="btn" id="restartBtn">Chase Again</button>
  <div class="share-btns">
    <button class="share-btn" id="shareBtn"><i class="fab fa-x-twitter"></i> Share</button>
    <button class="share-btn" id="copyBtn"><i class="fas fa-copy"></i> Copy</button>
  </div>
</div>

<canvas id="game"></canvas>

<script>
const CV = document.getElementById('game');
const cx = CV.getContext('2d');

let W, H, dpr;
function resize() {
  dpr = window.devicePixelRatio || 1;
  W = window.innerWidth; H = window.innerHeight;
  CV.width = W * dpr; CV.height = H * dpr;
  CV.style.width = W + 'px'; CV.style.height = H + 'px';
  cx.setTransform(dpr, 0, 0, dpr, 0, 0);
  ROAD_L = W / 2 - ROAD_W / 2;
  ROAD_R = W / 2 + ROAD_W / 2;
}

const TOP = 80; // nav+hud
const ROAD_W = 240;
let ROAD_L, ROAD_R;
const LANE_COUNT = 4;
const CAR_W = 22, CAR_H = 38;

resize();
window.addEventListener('resize', resize);

// ─── INPUT ───
const keys = {};
window.addEventListener('keydown', e => { keys[e.key.toLowerCase()] = true; e.preventDefault(); });
window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

let touchLeft = false, touchRight = false, touchUp = false, touchDown = false;

CV.addEventListener('touchstart', e => {
  e.preventDefault();
  for (const t of e.touches) {
    if (t.clientY > H * 0.7) {
      // Bottom zone = accelerate
      touchUp = true;
    }
    if (t.clientX < W * 0.35) touchLeft = true;
    if (t.clientX > W * 0.65) touchRight = true;
  }
}, { passive: false });

CV.addEventListener('touchend', e => {
  if (e.touches.length === 0) {
    touchLeft = false; touchRight = false; touchUp = false; touchDown = false;
  }
});

function goLeft() { return keys['a'] || keys['arrowleft'] || touchLeft; }
function goRight() { return keys['d'] || keys['arrowright'] || touchRight; }
function goUp() { return keys['w'] || keys['arrowup'] || touchUp; }
function goDown() { return keys['s'] || keys['arrowdown'] || touchDown; }

// ─── STATE ───
let gameRunning = false, lastTime = 0;
let score = 0, busts = 0;
let scrollSpeed = 0; // visual road scroll speed
let roadScroll = 0;
let player, runner;
let civilians = [], tireMarks = [], effects = [], sparks = [];
let gapDist = 0; // how far ahead runner is (0 = right on them, 500 = escaped)
const MAX_GAP = 500;
let flashTimer = 0;
let ramCooldown = 0;
let shakeX = 0, shakeY = 0, shakeTimer = 0;

function laneX(lane) {
  const laneW = ROAD_W / LANE_COUNT;
  return ROAD_L + laneW * lane + laneW / 2;
}

function createPlayer() {
  return { x: W / 2, y: H * 0.72, speed: 200, steerVel: 0, tilt: 0 };
}

function createRunner(bust) {
  const b = bust || 0;
  return {
    x: W / 2, y: H * 0.22,
    baseSpeed: 220 + b * 18,
    speed: 220 + b * 18,
    swerveTimer: 0,
    targetX: W / 2,
    agility: 2.5 + b * 0.15,
    tilt: 0,
  };
}

// ─── DRAW: LOW-POLY CAR ───
function drawCarBody(x, y, w, h, tilt, colors, isICE, isRunner) {
  cx.save();
  cx.translate(x, y);

  // Slight rotation from steering
  cx.rotate(tilt * 0.06);

  const hw = w / 2, hh = h / 2;

  // Shadow
  cx.fillStyle = 'rgba(0,0,0,0.3)';
  cx.beginPath();
  cx.moveTo(-hw + 1, -hh + 6);
  cx.lineTo(hw + 3, -hh + 6);
  cx.lineTo(hw + 1, hh + 4);
  cx.lineTo(-hw + 3, hh + 4);
  cx.closePath();
  cx.fill();

  // Main body (low-poly: flat colored with angular shape)
  cx.fillStyle = colors.body;
  cx.beginPath();
  cx.moveTo(-hw + 3, -hh);       // front left
  cx.lineTo(hw - 3, -hh);        // front right
  cx.lineTo(hw, -hh + 6);
  cx.lineTo(hw, hh - 4);
  cx.lineTo(hw - 2, hh);         // rear right
  cx.lineTo(-hw + 2, hh);        // rear left
  cx.lineTo(-hw, hh - 4);
  cx.lineTo(-hw, -hh + 6);
  cx.closePath();
  cx.fill();

  // Hood (front section - slightly lighter)
  cx.fillStyle = colors.hood;
  cx.beginPath();
  cx.moveTo(-hw + 3, -hh);
  cx.lineTo(hw - 3, -hh);
  cx.lineTo(hw - 1, -hh + 10);
  cx.lineTo(-hw + 1, -hh + 10);
  cx.closePath();
  cx.fill();

  // Windshield
  cx.fillStyle = colors.glass;
  cx.beginPath();
  cx.moveTo(-hw + 4, -hh + 10);
  cx.lineTo(hw - 4, -hh + 10);
  cx.lineTo(hw - 5, -hh + 17);
  cx.lineTo(-hw + 5, -hh + 17);
  cx.closePath();
  cx.fill();

  // Roof
  cx.fillStyle = colors.roof;
  cx.beginPath();
  cx.moveTo(-hw + 5, -hh + 17);
  cx.lineTo(hw - 5, -hh + 17);
  cx.lineTo(hw - 4, hh - 14);
  cx.lineTo(-hw + 4, hh - 14);
  cx.closePath();
  cx.fill();

  // Rear window
  cx.fillStyle = colors.glass;
  cx.beginPath();
  cx.moveTo(-hw + 5, hh - 14);
  cx.lineTo(hw - 5, hh - 14);
  cx.lineTo(hw - 4, hh - 8);
  cx.lineTo(-hw + 4, hh - 8);
  cx.closePath();
  cx.fill();

  // Trunk
  cx.fillStyle = colors.body;
  cx.fillRect(-hw + 3, hh - 8, w - 6, 6);

  // Headlights (front)
  cx.fillStyle = 'rgba(255,255,220,0.7)';
  cx.fillRect(-hw + 2, -hh, 4, 3);
  cx.fillRect(hw - 6, -hh, 4, 3);

  // Taillights
  cx.fillStyle = colors.tail;
  cx.fillRect(-hw + 2, hh - 3, 5, 3);
  cx.fillRect(hw - 7, hh - 3, 5, 3);

  // Wheels (flat dark rectangles)
  cx.fillStyle = '#1a1a1a';
  cx.fillRect(-hw - 2, -hh + 5, 3, 9);
  cx.fillRect(hw - 1, -hh + 5, 3, 9);
  cx.fillRect(-hw - 2, hh - 14, 3, 9);
  cx.fillRect(hw - 1, hh - 14, 3, 9);

  // Wheel faces
  cx.fillStyle = '#333';
  cx.fillRect(-hw - 1, -hh + 6, 1, 7);
  cx.fillRect(hw, -hh + 6, 1, 7);
  cx.fillRect(-hw - 1, hh - 13, 1, 7);
  cx.fillRect(hw, hh - 13, 1, 7);

  if (isICE) {
    // Light bar on roof
    const flash = Math.sin(Date.now() * 0.015);
    cx.fillStyle = flash > 0 ? 'rgba(255,40,40,0.85)' : 'rgba(40,80,255,0.85)';
    cx.fillRect(-hw + 6, -hh + 18, (w - 12) / 2 - 1, 3);
    cx.fillStyle = flash > 0 ? 'rgba(40,80,255,0.85)' : 'rgba(255,40,40,0.85)';
    cx.fillRect(1, -hh + 18, (w - 12) / 2 - 1, 3);

    // Light glow
    cx.fillStyle = flash > 0 ? 'rgba(255,40,40,0.05)' : 'rgba(40,80,255,0.05)';
    cx.beginPath();
    cx.arc(0, -hh + 19, 30, 0, Math.PI * 2);
    cx.fill();

    // ICE text on roof
    cx.fillStyle = 'rgba(255,255,255,0.55)';
    cx.font = '700 6px Oswald, sans-serif';
    cx.textAlign = 'center';
    cx.fillText('ICE', 0, -hh + 28);

    // Side stripe
    cx.fillStyle = 'rgba(255,255,255,0.12)';
    cx.fillRect(-hw, -2, w, 2);
  }

  if (isRunner) {
    // Darker tinted windows
    cx.fillStyle = 'rgba(0,0,0,0.15)';
    cx.fillRect(-hw + 5, -hh + 17, w - 10, hh - 14 - (-hh + 17));
  }

  cx.restore();
}

const ICE_COLORS = {
  body: '#1e4480',
  hood: '#2558a0',
  roof: '#1a3d6e',
  glass: 'rgba(100,170,255,0.3)',
  tail: 'rgba(255,40,40,0.5)',
};

const RUNNER_COLORS = {
  body: '#aa2222',
  hood: '#cc3333',
  roof: '#882020',
  glass: 'rgba(40,40,40,0.5)',
  tail: 'rgba(255,50,50,0.7)',
};

const CIV_PALETTES = [
  { body:'#b0b0b0', hood:'#c0c0c0', roof:'#999', glass:'rgba(120,180,220,0.2)', tail:'rgba(255,50,50,0.3)' },
  { body:'#8a8a7a', hood:'#9a9a8a', roof:'#7a7a6a', glass:'rgba(120,180,220,0.2)', tail:'rgba(255,50,50,0.3)' },
  { body:'#606878', hood:'#707888', roof:'#505868', glass:'rgba(120,180,220,0.2)', tail:'rgba(255,50,50,0.3)' },
  { body:'#886644', hood:'#997755', roof:'#775533', glass:'rgba(120,180,220,0.2)', tail:'rgba(255,50,50,0.3)' },
  { body:'#e8e0d0', hood:'#f0e8d8', roof:'#d8d0c0', glass:'rgba(120,180,220,0.2)', tail:'rgba(255,50,50,0.3)' },
];

// ─── DRAW ROAD ───
function drawRoad() {
  // Grass/ground
  cx.fillStyle = '#151e15';
  cx.fillRect(0, 0, W, H);

  // Sidewalks
  cx.fillStyle = '#2a2a2a';
  cx.fillRect(ROAD_L - 16, 0, 16, H);
  cx.fillRect(ROAD_R, 0, 16, H);
  // Curb edge
  cx.fillStyle = '#444';
  cx.fillRect(ROAD_L - 1, 0, 1, H);
  cx.fillRect(ROAD_R, 0, 1, H);

  // Road
  cx.fillStyle = '#222';
  cx.fillRect(ROAD_L, 0, ROAD_W, H);

  // Subtle road texture
  cx.fillStyle = 'rgba(255,255,255,0.01)';
  const texOff = roadScroll % 4;
  for (let y = -texOff; y < H; y += 4) {
    cx.fillRect(ROAD_L, y, ROAD_W, 1);
  }

  // Lane markings
  const dashLen = 22, gapLen = 28;
  const totalDash = dashLen + gapLen;
  const dashOff = roadScroll % totalDash;

  cx.fillStyle = 'rgba(255,255,255,0.18)';
  const laneW = ROAD_W / LANE_COUNT;
  for (let i = 1; i < LANE_COUNT; i++) {
    const lx = ROAD_L + laneW * i;
    if (i === LANE_COUNT / 2) continue; // center line is different
    for (let y = -dashOff - dashLen; y < H + dashLen; y += totalDash) {
      cx.fillRect(lx - 1, y, 2, dashLen);
    }
  }

  // Center double yellow
  const clx = ROAD_L + laneW * (LANE_COUNT / 2);
  cx.fillStyle = 'rgba(220,180,50,0.2)';
  cx.fillRect(clx - 3, 0, 2, H);
  cx.fillRect(clx + 1, 0, 2, H);

  // Tire marks
  tireMarks.forEach(tm => {
    const a = Math.min(1, tm.life) * 0.35;
    cx.fillStyle = `rgba(15,15,15,${a})`;
    cx.save();
    cx.translate(tm.x, tm.y);
    cx.rotate(tm.angle || 0);
    cx.fillRect(-1, 0, 2, tm.len || 10);
    cx.restore();
  });
}

function drawBuildings() {
  const bOff = (roadScroll * 0.2) % 160;
  cx.fillStyle = '#0e140e';
  for (let y = -bOff; y < H; y += 80) {
    // Left
    const lh = 30 + (y * 7 % 30);
    cx.fillRect(0, y, ROAD_L - 20, lh);
    cx.fillStyle = '#0e140e';
    // Right
    const rh = 25 + ((y * 11 + 40) % 35);
    cx.fillRect(ROAD_R + 20, y + 15, W - ROAD_R - 20, rh);
    cx.fillStyle = '#0e140e';
  }
  // Windows
  cx.fillStyle = 'rgba(200,180,100,0.07)';
  for (let y = -bOff; y < H; y += 80) {
    for (let x = 4; x < ROAD_L - 24; x += 10) {
      if ((x * 3 + y * 7) % 5 < 3) cx.fillRect(x, y + 4, 4, 4);
    }
    for (let x = ROAD_R + 24; x < W - 4; x += 10) {
      if ((x * 5 + y * 3) % 5 < 3) cx.fillRect(x, y + 19, 4, 4);
    }
  }
}

// ─── SPARKS ───
function addSparks(x, y, count) {
  for (let i = 0; i < count; i++) {
    sparks.push({
      x, y,
      vx: (Math.random() - 0.5) * 150,
      vy: (Math.random() - 0.5) * 150,
      life: 0.3 + Math.random() * 0.3,
      color: Math.random() > 0.5 ? '#ff8' : '#fa4',
    });
  }
}

function drawSparks() {
  sparks.forEach(s => {
    cx.fillStyle = s.color;
    cx.globalAlpha = s.life * 2;
    cx.fillRect(s.x, s.y, 2, 2);
  });
  cx.globalAlpha = 1;
}

// ─── GAP INDICATOR ───
function drawGapBar() {
  const bw = 140, bh = 5;
  const bx = W / 2 - bw / 2, by = TOP + 6;

  cx.fillStyle = 'rgba(0,0,0,0.4)';
  cx.beginPath(); cx.roundRect(bx - 3, by - 3, bw + 6, bh + 16, 4); cx.fill();

  cx.fillStyle = 'rgba(255,255,255,0.08)';
  cx.beginPath(); cx.roundRect(bx, by, bw, bh, 2); cx.fill();

  const pct = Math.min(1, gapDist / MAX_GAP);
  const col = pct < 0.4 ? '#43A047' : pct < 0.7 ? '#F0A830' : '#D32F2F';
  cx.fillStyle = col;
  cx.beginPath(); cx.roundRect(bx, by, bw * pct, bh, 2); cx.fill();

  // Labels
  cx.fillStyle = 'rgba(255,255,255,0.3)';
  cx.font = '600 7px Oswald, sans-serif';
  cx.textAlign = 'center';
  const label = pct < 0.3 ? 'ON THEIR TAIL' : pct < 0.6 ? 'CLOSING IN' : pct < 0.85 ? 'GETTING AWAY' : 'ALMOST ESCAPED';
  cx.fillText(label, W / 2, by + bh + 10);
}

// ─── EFFECTS ───
function drawEffects() {
  cx.textAlign = 'center';
  effects.forEach(e => {
    cx.globalAlpha = Math.min(1, e.life);
    cx.fillStyle = e.color;
    cx.font = `700 ${e.size || 16}px Oswald, sans-serif`;
    cx.fillText(e.text, e.x, e.y - (1 - Math.min(1, e.life)) * 30);
  });
  cx.globalAlpha = 1;
}

// ─── UPDATE ───
function update(dt) {
  if (!gameRunning) return;

  const p = player;
  const r = runner;

  // Player acceleration
  if (goUp()) p.speed += 300 * dt;
  else if (goDown()) p.speed -= 400 * dt;
  else p.speed -= 80 * dt;
  p.speed = Math.max(40, Math.min(380, p.speed));

  // Player steering
  const steerForce = 350;
  if (goLeft()) p.steerVel -= steerForce * dt;
  else if (goRight()) p.steerVel += steerForce * dt;
  else p.steerVel *= (1 - 5 * dt); // return to center

  p.steerVel = Math.max(-250, Math.min(250, p.steerVel));
  p.x += p.steerVel * dt;
  p.tilt = p.steerVel / 250; // -1 to 1

  // Clamp to road
  const margin = CAR_W / 2 + 4;
  if (p.x < ROAD_L + margin) { p.x = ROAD_L + margin; p.steerVel = Math.abs(p.steerVel) * 0.3; p.speed *= 0.85; addSparks(p.x, p.y, 3); }
  if (p.x > ROAD_R - margin) { p.x = ROAD_R - margin; p.steerVel = -Math.abs(p.steerVel) * 0.3; p.speed *= 0.85; addSparks(p.x, p.y, 3); }

  // Tire marks when turning hard
  if (Math.abs(p.tilt) > 0.5 && p.speed > 150) {
    tireMarks.push({ x: p.x - 6, y: p.y + 12, angle: p.tilt * 0.08, len: 8, life: 2.5 });
    tireMarks.push({ x: p.x + 6, y: p.y + 12, angle: p.tilt * 0.08, len: 8, life: 2.5 });
  }

  // Road scroll
  scrollSpeed = p.speed;
  roadScroll += scrollSpeed * dt;

  // Runner AI
  r.swerveTimer -= dt;
  if (r.swerveTimer <= 0) {
    r.swerveTimer = 0.8 + Math.random() * 1.5;
    // Pick a random lane, biased away from player
    const lanes = [];
    for (let i = 0; i < LANE_COUNT; i++) lanes.push(laneX(i));
    // Filter to lanes away from player
    let choices = lanes.filter(lx => Math.abs(lx - p.x) > ROAD_W / LANE_COUNT * 0.8);
    if (choices.length === 0) choices = lanes;
    r.targetX = choices[Math.floor(Math.random() * choices.length)];
  }

  const rx_err = r.targetX - r.x;
  r.x += rx_err * r.agility * dt;
  r.x = Math.max(ROAD_L + margin, Math.min(ROAD_R - margin, r.x));
  r.tilt = (rx_err * r.agility * dt * 50); // visual tilt

  // Runner speed varies
  r.speed = r.baseSpeed + Math.sin(Date.now() * 0.002) * 20;

  // Runner Y: visual position based on gap
  const runnerVisualY = Math.max(TOP + 20, p.y - 150 - gapDist * 0.6);
  r.y += (runnerVisualY - r.y) * 4 * dt;

  // Gap distance
  const relSpeed = r.speed - p.speed;
  gapDist += relSpeed * dt * 0.5;
  gapDist = Math.max(0, gapDist);

  if (gapDist >= MAX_GAP) { endGame(); return; }

  // Ram detection
  ramCooldown -= dt;
  const dx = p.x - r.x, dy = p.y - r.y;
  const dist = Math.sqrt(dx * dx + dy * dy);
  if (dist < 35 && ramCooldown <= 0 && p.speed > 100) {
    ramCooldown = 1.2;
    busts++;
    const pts = 100 + busts * 50;
    score += pts;
    gapDist = 0;

    effects.push({ x: r.x, y: r.y, text: 'BUSTED +' + pts, color: '#F0A830', life: 1.8, size: 20 });
    addSparks(r.x, r.y, 12);
    flashTimer = 0.12;
    shakeTimer = 0.2;

    p.speed *= 0.5;

    // New runner after delay
    const oldRunner = runner;
    setTimeout(() => {
      runner = createRunner(busts);
      runner.x = laneX(Math.floor(Math.random() * LANE_COUNT));
      effects.push({ x: W / 2, y: H * 0.3, text: 'NEW SUSPECT', color: '#ff4444', life: 2, size: 14 });
    }, 600);
  }

  // Civilians
  if (Math.random() < dt * (1.2 + busts * 0.25)) {
    const lane = Math.floor(Math.random() * LANE_COUNT);
    const goingUp = lane < LANE_COUNT / 2;
    civilians.push({
      x: laneX(lane),
      y: goingUp ? H + CAR_H : -CAR_H * 2,
      dir: goingUp ? -1 : 1,
      speed: 60 + Math.random() * 40,
      palette: CIV_PALETTES[Math.floor(Math.random() * CIV_PALETTES.length)],
      hit: false,
      tilt: 0,
    });
  }

  civilians.forEach(c => {
    c.y += c.dir * c.speed * dt;
    // Scroll
    c.y += scrollSpeed * 0.4 * dt;

    // Collision with player
    if (!c.hit) {
      const cdx = p.x - c.x, cdy = p.y - c.y;
      if (Math.abs(cdx) < CAR_W * 0.9 && Math.abs(cdy) < CAR_H * 0.8) {
        c.hit = true;
        p.speed *= 0.35;
        p.steerVel += (p.x - c.x) * 3;
        effects.push({ x: c.x, y: c.y, text: 'CRASH', color: '#ff4444', life: 1, size: 14 });
        addSparks((p.x + c.x) / 2, (p.y + c.y) / 2, 8);
        shakeTimer = 0.15;
        c.x += (c.x - p.x) * 2;
        c.tilt = (c.x - p.x) * 0.05;
      }
    }
  });

  civilians = civilians.filter(c => c.y > -100 && c.y < H + 100);

  // Tire marks fade + scroll
  tireMarks.forEach(tm => { tm.life -= dt; tm.y += scrollSpeed * 0.4 * dt; });
  tireMarks = tireMarks.filter(tm => tm.life > 0 && tm.y < H + 20);

  // Sparks
  sparks.forEach(s => { s.x += s.vx * dt; s.y += s.vy * dt; s.life -= dt; });
  sparks = sparks.filter(s => s.life > 0);

  // Effects
  effects.forEach(e => e.life -= dt * 0.7);
  effects = effects.filter(e => e.life > 0);

  // Shake
  if (shakeTimer > 0) {
    shakeX = (Math.random() - 0.5) * 6;
    shakeY = (Math.random() - 0.5) * 6;
    shakeTimer -= dt;
  } else {
    shakeX = 0; shakeY = 0;
  }

  // HUD
  document.getElementById('hudScore').textContent = score;
  document.getElementById('hudBusts').textContent = busts;
  document.getElementById('hudSpeed').textContent = Math.floor(p.speed);
  document.getElementById('hudDist').textContent = Math.floor(100 - (gapDist / MAX_GAP * 100)) + '%';
}

// ─── DRAW ───
function draw() {
  cx.clearRect(0, 0, W, H);

  cx.save();
  cx.translate(shakeX, shakeY);

  drawRoad();
  drawBuildings();

  // Civilians (behind runner)
  civilians.forEach(c => {
    drawCarBody(c.x, c.y, CAR_W * 0.9, CAR_H * 0.85, c.tilt, c.palette, false, false);
  });

  // Runner
  if (runner) {
    drawCarBody(runner.x, runner.y, CAR_W, CAR_H, runner.tilt, RUNNER_COLORS, false, true);
    // Runner taillights glow
    if (runner.speed > 0) {
      cx.fillStyle = 'rgba(255,30,30,0.08)';
      cx.beginPath();
      cx.ellipse(runner.x, runner.y + CAR_H / 2 + 8, 15, 8, 0, 0, Math.PI * 2);
      cx.fill();
    }
  }

  // Player
  drawCarBody(player.x, player.y, CAR_W * 1.05, CAR_H * 1.02, player.tilt, ICE_COLORS, true, false);

  // Headlight beams
  cx.save();
  cx.translate(player.x, player.y);
  const hlg = cx.createRadialGradient(0, -CAR_H, 5, 0, -CAR_H * 3, CAR_W * 1.8);
  hlg.addColorStop(0, 'rgba(255,255,210,0.06)');
  hlg.addColorStop(1, 'rgba(255,255,210,0)');
  cx.fillStyle = hlg;
  cx.beginPath();
  cx.moveTo(-6, -CAR_H / 2);
  cx.lineTo(-CAR_W * 1.5, -CAR_H * 4);
  cx.lineTo(CAR_W * 1.5, -CAR_H * 4);
  cx.lineTo(6, -CAR_H / 2);
  cx.closePath();
  cx.fill();
  cx.restore();

  drawSparks();
  drawGapBar();
  drawEffects();

  cx.restore(); // shake

  // Flash
  if (flashTimer > 0) {
    cx.fillStyle = `rgba(255,255,255,${flashTimer * 4})`;
    cx.fillRect(0, 0, W, H);
    flashTimer -= 0.016;
  }

  // Night vignette
  const vg = cx.createRadialGradient(W / 2, H * 0.5, H * 0.2, W / 2, H * 0.5, H * 0.7);
  vg.addColorStop(0, 'rgba(0,0,0,0)');
  vg.addColorStop(1, 'rgba(0,0,0,0.35)');
  cx.fillStyle = vg;
  cx.fillRect(0, 0, W, H);

  // Touch guide on mobile
  if ('ontouchstart' in window && gameRunning) {
    cx.fillStyle = 'rgba(255,255,255,0.03)';
    cx.fillRect(0, H * 0.5, W * 0.3, H * 0.5);
    cx.fillRect(W * 0.7, H * 0.5, W * 0.3, H * 0.5);
  }
}

// ─── LOOP ───
function loop(ts) {
  const dt = Math.min((ts - lastTime) / 1000, 0.05);
  lastTime = ts;
  update(dt);
  draw();
  requestAnimationFrame(loop);
}

// ─── START / END ───
function startGame() {
  score = 0; busts = 0; gapDist = 0; roadScroll = 0;
  player = createPlayer();
  runner = createRunner(0);
  civilians = []; tireMarks = []; effects = []; sparks = [];
  flashTimer = 0; ramCooldown = 0; shakeTimer = 0;
  gameRunning = true;
  document.getElementById('hud').style.display = 'flex';
  document.getElementById('startScreen').classList.add('hidden');
  document.getElementById('gameOverScreen').classList.add('hidden');
}

function endGame() {
  gameRunning = false;
  document.getElementById('goTitle').textContent = 'Suspect Escaped';
  document.getElementById('goTitle').style.color = '#D32F2F';
  document.getElementById('goSub').textContent = `You busted ${busts} suspect${busts !== 1 ? 's' : ''} with a score of ${score}.`;
  document.getElementById('goStats').innerHTML = `
    <div class="stat-row"><span class="stat-label">Score</span><span class="stat-val">${score}</span></div>
    <div class="stat-row"><span class="stat-label">Busts</span><span class="stat-val">${busts}</span></div>`;
  document.getElementById('gameOverScreen').classList.remove('hidden');
}

function shareText() {
  return `ICE CHASE\n\nScore: ${score}\nBusts: ${busts}\n\nCan you catch more?\nufcr.online/ice-chase/`;
}

document.getElementById('startBtn').addEventListener('click', startGame);
document.getElementById('restartBtn').addEventListener('click', startGame);
document.getElementById('shareBtn').addEventListener('click', () => {
  window.open('https://x.com/intent/tweet?text=' + encodeURIComponent(shareText()), '_blank');
});
document.getElementById('copyBtn').addEventListener('click', () => {
  navigator.clipboard.writeText(shareText()).then(() => {
    document.getElementById('copyBtn').innerHTML = '<i class="fas fa-check"></i> Copied!';
    setTimeout(() => { document.getElementById('copyBtn').innerHTML = '<i class="fas fa-copy"></i> Copy'; }, 2000);
  });
});

requestAnimationFrame(loop);
</script>
</body>
</html>
