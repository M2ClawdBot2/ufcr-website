<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>ICE CHASE — UFCR Games</title>
  <link rel="icon" href="../assets/images/shield-logo.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Oswald:wght@500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    :root{--orange:#FA4616;--gold:#F0A830;--navy:#001845;--dark:#0A0E1A;--red:#D32F2F;--green:#43A047;--blue:#2558a0;--font-body:'Inter',sans-serif;--font-heading:'Oswald',sans-serif}
    *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
    html,body{width:100%;height:100%;overflow:hidden;font-family:var(--font-body);background:#4a8c5c;color:#fff;-webkit-tap-highlight-color:transparent;user-select:none;touch-action:none}
    .nav{position:fixed;top:0;left:0;right:0;z-index:100;height:44px;background:rgba(0,24,69,.95);backdrop-filter:blur(20px);border-bottom:1px solid rgba(255,255,255,.06);display:flex;align-items:center;justify-content:space-between;padding:0 12px}
    .nav-logo{display:flex;align-items:center;gap:6px;text-decoration:none;color:#fff}
    .nav-logo img{height:26px;border-radius:3px;background:#fff;padding:1px}
    .nav-logo span{font-family:var(--font-heading);font-size:.95rem;font-weight:700;letter-spacing:.08em}
    .nav-back{font-size:.65rem;color:rgba(255,255,255,.5);text-decoration:none;letter-spacing:.1em;text-transform:uppercase;font-weight:600}
    .hud{position:fixed;top:44px;left:0;right:0;z-index:90;display:flex;justify-content:space-between;padding:6px 16px;background:rgba(0,24,69,.7);backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,255,255,.05)}
    .hud-item{text-align:center;flex:1}
    .hud-label{font-size:.5rem;text-transform:uppercase;letter-spacing:.15em;color:rgba(255,255,255,.3)}
    .hud-value{font-family:var(--font-heading);font-size:1.1rem;font-weight:700}
    .hud-value.score{color:var(--gold)}.hud-value.spd{color:#7cf}.hud-value.dist{color:var(--orange)}.hud-value.busts{color:#8bf}
    canvas{position:fixed;top:0;left:0;width:100%;height:100%;display:block}
    .screen-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(5,8,18,.94);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:200;padding:24px;text-align:center}
    .screen-overlay.hidden{display:none}
    .screen-title{font-family:var(--font-heading);font-size:clamp(2.2rem,8vw,4rem);font-weight:700;text-transform:uppercase;letter-spacing:.04em;margin-bottom:6px}
    .screen-sub{font-size:.9rem;color:rgba(255,255,255,.45);margin-bottom:24px;max-width:380px;line-height:1.6}
    .screen-stats{margin-bottom:24px;min-width:220px}
    .stat-row{display:flex;justify-content:space-between;font-size:.9rem;padding:5px 0;border-bottom:1px solid rgba(255,255,255,.05)}
    .stat-label{color:rgba(255,255,255,.35)}.stat-val{font-weight:700;color:var(--gold)}
    .level-badge{font-family:var(--font-heading);font-size:.65rem;font-weight:600;letter-spacing:.2em;text-transform:uppercase;color:var(--gold);margin-bottom:6px}
    .btn{font-family:var(--font-heading);font-size:1rem;font-weight:600;letter-spacing:.12em;text-transform:uppercase;background:var(--orange);color:#fff;border:none;padding:12px 32px;cursor:pointer;transition:all .3s}
    .btn:hover{background:#e03a0e;transform:translateY(-2px)}
    .share-btns{display:flex;gap:10px;margin-top:12px}
    .share-btn{font-family:var(--font-heading);font-size:.65rem;font-weight:600;letter-spacing:.1em;text-transform:uppercase;padding:8px 14px;border:1px solid rgba(255,255,255,.12);background:transparent;color:#fff;cursor:pointer;display:flex;align-items:center;gap:5px;transition:all .3s}
    .share-btn:hover{background:rgba(255,255,255,.06)}
    .how-to{max-width:360px;margin-bottom:20px;text-align:left}
    .how-to li{font-size:.82rem;color:rgba(255,255,255,.5);margin-bottom:5px;line-height:1.5;list-style:none;padding-left:18px;position:relative}
    .how-to li::before{content:'';position:absolute;left:0;top:7px;width:6px;height:6px;background:var(--orange);border-radius:50%}
  </style>
</head>
<body>

<nav class="nav">
  <a href="../" class="nav-logo"><img src="../assets/images/shield-logo.png" alt="UFCR"><span>UFCR</span></a>
  <a href="../games/" class="nav-back"><i class="fas fa-arrow-left"></i> Games</a>
</nav>

<div class="hud" id="hud" style="display:none">
  <div class="hud-item"><div class="hud-label">Score</div><div class="hud-value score" id="hudScore">0</div></div>
  <div class="hud-item"><div class="hud-label">Busts</div><div class="hud-value busts" id="hudBusts">0</div></div>
  <div class="hud-item"><div class="hud-label">Speed</div><div class="hud-value spd" id="hudSpeed">0</div></div>
  <div class="hud-item"><div class="hud-label">Gap</div><div class="hud-value dist" id="hudDist">---</div></div>
</div>

<div class="screen-overlay" id="startScreen">
  <div class="level-badge">UFCR GAMES</div>
  <div class="screen-title" style="color:var(--orange)">ICE CHASE</div>
  <p class="screen-sub">High-speed pursuit through city streets. Chase down the suspect and ram them off the road before they escape.</p>
  <ul class="how-to">
    <li><strong>Left / Right</strong> to steer (Arrow keys, A/D, or touch sides)</li>
    <li><strong>Up / W</strong> to accelerate</li>
    <li><strong>Down / S</strong> to brake</li>
    <li>Ram the red suspect car to bust them</li>
    <li>Dodge civilian cars — crashing costs speed</li>
    <li>Don't let the suspect get too far ahead</li>
  </ul>
  <button class="btn" id="startBtn">Start Chase</button>
</div>

<div class="screen-overlay hidden" id="gameOverScreen">
  <div class="level-badge">PURSUIT ENDED</div>
  <div class="screen-title" id="goTitle" style="color:var(--red)">Escaped</div>
  <p class="screen-sub" id="goSub"></p>
  <div class="screen-stats" id="goStats"></div>
  <button class="btn" id="restartBtn">Chase Again</button>
  <div class="share-btns">
    <button class="share-btn" id="shareBtn"><i class="fab fa-x-twitter"></i> Share</button>
    <button class="share-btn" id="copyBtn"><i class="fas fa-copy"></i> Copy</button>
  </div>
</div>

<canvas id="game"></canvas>

<script>
const CV = document.getElementById('game');
const cx = CV.getContext('2d');

let W, H, dpr, ROAD_L, ROAD_R;
const ROAD_W = 220;
const LANE_COUNT = 4;
const CAR_W = 22, CAR_H = 38;
const TOP = 80;

function resize() {
  dpr = window.devicePixelRatio || 1;
  W = window.innerWidth; H = window.innerHeight;
  CV.width = W * dpr; CV.height = H * dpr;
  CV.style.width = W + 'px'; CV.style.height = H + 'px';
  cx.setTransform(dpr, 0, 0, dpr, 0, 0);
  ROAD_L = W / 2 - ROAD_W / 2;
  ROAD_R = W / 2 + ROAD_W / 2;
}
resize();
window.addEventListener('resize', resize);

// ─── INPUT ───
const keys = {};
window.addEventListener('keydown', e => { keys[e.key.toLowerCase()] = true; if(['arrowup','arrowdown','arrowleft','arrowright',' '].includes(e.key.toLowerCase())) e.preventDefault(); });
window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

let tL = false, tR = false, tU = false;
CV.addEventListener('touchstart', e => {
  e.preventDefault();
  for (const t of e.changedTouches) {
    if (t.clientX < W * 0.33) tL = true;
    else if (t.clientX > W * 0.66) tR = true;
    tU = true; // any touch = accelerate
  }
}, { passive: false });
CV.addEventListener('touchend', e => {
  if (e.touches.length === 0) { tL = false; tR = false; tU = false; }
}, { passive: false });
CV.addEventListener('touchcancel', () => { tL = false; tR = false; tU = false; });

function goL() { return keys['a'] || keys['arrowleft'] || tL; }
function goR() { return keys['d'] || keys['arrowright'] || tR; }
function goU() { return keys['w'] || keys['arrowup'] || tU; }
function goD() { return keys['s'] || keys['arrowdown']; }

// ─── STATE ───
let gameRunning = false, lastTime = 0;
let score = 0, busts = 0;
let roadScroll = 0;
let player = null, runner = null;
let civilians = [], tireMarks = [], effects = [], sparks = [];
let gapDist = 0;
const MAX_GAP = 400;
let flashTimer = 0, shakeTimer = 0, shakeX = 0, shakeY = 0;
let ramCooldown = 0;

// Scenery objects (generated once)
let trees = [];
function genTrees() {
  trees = [];
  for (let i = 0; i < 80; i++) {
    const side = Math.random() > 0.5 ? 'left' : 'right';
    trees.push({
      side,
      offset: side === 'left' ? Math.random() * (ROAD_L - 30) : ROAD_R + 10 + Math.random() * (W - ROAD_R - 30),
      yBase: Math.random() * 2000,
      size: 6 + Math.random() * 10,
      shade: Math.random() * 0.2,
    });
  }
}

function laneX(i) {
  const lw = ROAD_W / LANE_COUNT;
  return ROAD_L + lw * i + lw / 2;
}

function mkPlayer() {
  return { x: W / 2, y: H * 0.7, speed: 180, steerVel: 0, tilt: 0 };
}

function mkRunner(b) {
  return {
    x: laneX(Math.floor(Math.random() * LANE_COUNT)),
    y: H * 0.25,
    baseSpeed: 200 + (b || 0) * 15,
    speed: 200 + (b || 0) * 15,
    swerveTimer: 0,
    targetX: W / 2,
    targetLane: Math.floor(LANE_COUNT / 2),
    tilt: 0,
  };
}

// ─── DRAW CAR (low-poly, colorful) ───
function drawCar(x, y, w, h, tilt, col, ice, suspect) {
  cx.save();
  cx.translate(x, y);
  cx.rotate((tilt || 0) * 0.05);
  const hw = w / 2, hh = h / 2;

  // Shadow
  cx.fillStyle = 'rgba(0,0,0,0.18)';
  cx.beginPath();
  cx.ellipse(2, 3, hw + 2, hh + 1, 0, 0, Math.PI * 2);
  cx.fill();

  // Body
  cx.fillStyle = col.body;
  cx.beginPath();
  cx.moveTo(-hw + 3, -hh);
  cx.lineTo(hw - 3, -hh);
  cx.lineTo(hw, -hh + 5);
  cx.lineTo(hw, hh - 3);
  cx.lineTo(hw - 2, hh);
  cx.lineTo(-hw + 2, hh);
  cx.lineTo(-hw, hh - 3);
  cx.lineTo(-hw, -hh + 5);
  cx.closePath();
  cx.fill();

  // Hood
  cx.fillStyle = col.hood;
  cx.beginPath();
  cx.moveTo(-hw + 3, -hh);
  cx.lineTo(hw - 3, -hh);
  cx.lineTo(hw - 1, -hh + 9);
  cx.lineTo(-hw + 1, -hh + 9);
  cx.closePath();
  cx.fill();

  // Windshield
  cx.fillStyle = col.glass;
  cx.fillRect(-hw + 4, -hh + 9, w - 8, 7);

  // Roof
  cx.fillStyle = col.roof;
  cx.fillRect(-hw + 4, -hh + 16, w - 8, h - 30);

  // Rear window
  cx.fillStyle = col.glass;
  cx.fillRect(-hw + 5, hh - 12, w - 10, 5);

  // Headlights
  cx.fillStyle = '#ffe';
  cx.fillRect(-hw + 2, -hh, 4, 2);
  cx.fillRect(hw - 6, -hh, 4, 2);

  // Taillights
  cx.fillStyle = col.tail || '#f44';
  cx.fillRect(-hw + 2, hh - 2, 5, 2);
  cx.fillRect(hw - 7, hh - 2, 5, 2);

  // Wheels
  cx.fillStyle = '#222';
  cx.fillRect(-hw - 2, -hh + 4, 3, 8);
  cx.fillRect(hw - 1, -hh + 4, 3, 8);
  cx.fillRect(-hw - 2, hh - 12, 3, 8);
  cx.fillRect(hw - 1, hh - 12, 3, 8);

  if (ice) {
    // Light bar
    const f = Math.sin(Date.now() * 0.015);
    cx.fillStyle = f > 0 ? '#f33' : '#44f';
    cx.fillRect(-hw + 5, -hh + 17, (w - 10) / 2 - 1, 3);
    cx.fillStyle = f > 0 ? '#44f' : '#f33';
    cx.fillRect(1, -hh + 17, (w - 10) / 2 - 1, 3);
    // Glow
    cx.fillStyle = f > 0 ? 'rgba(255,50,50,0.08)' : 'rgba(50,50,255,0.08)';
    cx.beginPath(); cx.arc(0, -hh + 18, 25, 0, Math.PI * 2); cx.fill();
    // ICE label
    cx.fillStyle = 'rgba(255,255,255,0.5)';
    cx.font = '700 5.5px Oswald,sans-serif';
    cx.textAlign = 'center';
    cx.fillText('ICE', 0, -hh + 28);
    // Side stripe
    cx.fillStyle = 'rgba(255,255,255,0.15)';
    cx.fillRect(-hw, 0, w, 1.5);
  }

  if (suspect) {
    // Tinted windows
    cx.fillStyle = 'rgba(0,0,0,0.12)';
    cx.fillRect(-hw + 4, -hh + 9, w - 8, h - 20);
  }

  cx.restore();
}

// ─── COLOR PALETTES ───
const ICE_COL = { body:'#2862b5', hood:'#3575d0', roof:'#1e4a8a', glass:'rgba(140,200,255,0.35)', tail:'#f44' };
const RUNNER_COL = { body:'#cc2828', hood:'#e03535', roof:'#9a1e1e', glass:'rgba(40,40,50,0.45)', tail:'#f66' };
const CIV_COLS = [
  { body:'#e8e0cc', hood:'#f0e8d4', roof:'#d8d0bc', glass:'rgba(140,190,220,0.25)', tail:'#e55' },
  { body:'#5599cc', hood:'#66aadd', roof:'#4488bb', glass:'rgba(140,190,220,0.25)', tail:'#e55' },
  { body:'#cc9944', hood:'#ddaa55', roof:'#bb8833', glass:'rgba(140,190,220,0.25)', tail:'#e55' },
  { body:'#77bb66', hood:'#88cc77', roof:'#66aa55', glass:'rgba(140,190,220,0.25)', tail:'#e55' },
  { body:'#cc77aa', hood:'#dd88bb', roof:'#bb6699', glass:'rgba(140,190,220,0.25)', tail:'#e55' },
  { body:'#aaaacc', hood:'#bbbbdd', roof:'#9999bb', glass:'rgba(140,190,220,0.25)', tail:'#e55' },
];

// ─── DRAW ROAD ───
function drawScene() {
  // Grass
  cx.fillStyle = '#4a8c5c';
  cx.fillRect(0, 0, W, H);

  // Grass texture
  cx.fillStyle = '#3d7a4e';
  const gOff = roadScroll % 16;
  for (let y = -gOff; y < H; y += 16) {
    for (let x = 0; x < W; x += 24) {
      if ((x + y * 3) % 48 < 16) cx.fillRect(x, y, 8, 3);
    }
  }

  // Trees
  const treeScroll = roadScroll % 2000;
  trees.forEach(t => {
    const ty = ((t.yBase - treeScroll) % (H + 200)) - 100;
    // Trunk
    cx.fillStyle = `rgba(90,60,30,${0.5 + t.shade})`;
    cx.fillRect(t.offset + t.size / 2 - 2, ty, 4, t.size * 0.6);
    // Canopy
    cx.fillStyle = `rgba(${50 + t.shade * 100},${120 + t.shade * 60},${40 + t.shade * 50},0.7)`;
    cx.beginPath();
    cx.arc(t.offset + t.size / 2, ty - t.size * 0.2, t.size * 0.55, 0, Math.PI * 2);
    cx.fill();
    cx.fillStyle = `rgba(${40 + t.shade * 80},${100 + t.shade * 50},${30 + t.shade * 40},0.5)`;
    cx.beginPath();
    cx.arc(t.offset + t.size / 2 + 3, ty - t.size * 0.1, t.size * 0.4, 0, Math.PI * 2);
    cx.fill();
  });

  // Sidewalks
  cx.fillStyle = '#b8b0a0';
  cx.fillRect(ROAD_L - 14, 0, 14, H);
  cx.fillRect(ROAD_R, 0, 14, H);
  // Sidewalk lines
  cx.fillStyle = '#a8a090';
  const swOff = roadScroll % 30;
  for (let y = -swOff; y < H; y += 30) {
    cx.fillRect(ROAD_L - 14, y, 14, 1);
    cx.fillRect(ROAD_R, y, 14, 1);
  }

  // Road
  cx.fillStyle = '#555';
  cx.fillRect(ROAD_L, 0, ROAD_W, H);

  // Road texture
  cx.fillStyle = 'rgba(0,0,0,0.05)';
  const rtOff = roadScroll % 6;
  for (let y = -rtOff; y < H; y += 6) {
    cx.fillRect(ROAD_L, y, ROAD_W, 1);
  }

  // Curbs
  cx.fillStyle = '#ddd';
  cx.fillRect(ROAD_L - 1, 0, 2, H);
  cx.fillRect(ROAD_R - 1, 0, 2, H);

  // Lane dashes
  const dashLen = 20, gapLen = 25;
  const total = dashLen + gapLen;
  const dOff = roadScroll % total;
  cx.fillStyle = 'rgba(255,255,255,0.35)';
  const lw = ROAD_W / LANE_COUNT;
  for (let i = 1; i < LANE_COUNT; i++) {
    if (i === LANE_COUNT / 2) continue;
    const lx = ROAD_L + lw * i;
    for (let y = -dOff - dashLen; y < H + dashLen; y += total) {
      cx.fillRect(lx - 1, y, 2, dashLen);
    }
  }

  // Center double yellow
  const clx = ROAD_L + lw * (LANE_COUNT / 2);
  cx.fillStyle = 'rgba(240,200,50,0.5)';
  cx.fillRect(clx - 3, 0, 2, H);
  cx.fillRect(clx + 1, 0, 2, H);

  // Tire marks
  tireMarks.forEach(tm => {
    cx.fillStyle = `rgba(40,40,40,${Math.min(1, tm.life) * 0.3})`;
    cx.fillRect(tm.x - 1, tm.y, 2, 8);
  });
}

// ─── SPARKS ───
function drawSparks() {
  sparks.forEach(s => {
    cx.globalAlpha = Math.min(1, s.life * 3);
    cx.fillStyle = s.color;
    cx.fillRect(s.x, s.y, 2, 2);
  });
  cx.globalAlpha = 1;
}

function addSparks(x, y, n) {
  for (let i = 0; i < n; i++) {
    sparks.push({
      x, y,
      vx: (Math.random() - 0.5) * 160,
      vy: (Math.random() - 0.5) * 160,
      life: 0.2 + Math.random() * 0.3,
      color: ['#ff8','#fa4','#fff','#ff6'][Math.floor(Math.random() * 4)],
    });
  }
}

// ─── GAP BAR ───
function drawGapBar() {
  const bw = 130, bh = 5;
  const bx = W / 2 - bw / 2, by = TOP + 5;
  cx.fillStyle = 'rgba(0,0,0,0.35)';
  cx.beginPath(); cx.roundRect(bx - 3, by - 3, bw + 6, bh + 15, 4); cx.fill();
  cx.fillStyle = 'rgba(255,255,255,0.1)';
  cx.beginPath(); cx.roundRect(bx, by, bw, bh, 2); cx.fill();
  const pct = Math.min(1, gapDist / MAX_GAP);
  cx.fillStyle = pct < 0.4 ? '#5cb85c' : pct < 0.7 ? '#f0ad4e' : '#d9534f';
  cx.beginPath(); cx.roundRect(bx, by, bw * pct, bh, 2); cx.fill();
  cx.fillStyle = 'rgba(255,255,255,0.4)';
  cx.font = '600 7px Oswald,sans-serif';
  cx.textAlign = 'center';
  const label = pct < 0.3 ? 'ON THEIR TAIL' : pct < 0.6 ? 'CLOSING IN' : pct < 0.85 ? 'GETTING AWAY' : 'ALMOST ESCAPED';
  cx.fillText(label, W / 2, by + bh + 10);
}

function drawEffects() {
  cx.textAlign = 'center';
  effects.forEach(e => {
    cx.globalAlpha = Math.min(1, e.life);
    cx.fillStyle = e.color;
    cx.font = `700 ${e.size || 16}px Oswald,sans-serif`;
    cx.fillText(e.text, e.x, e.y - (1 - Math.min(1, e.life)) * 25);
  });
  cx.globalAlpha = 1;
}

// ─── UPDATE ───
function update(dt) {
  if (!gameRunning || !player || !runner) return;

  const p = player, r = runner;

  // Accelerate
  if (goU()) p.speed += 320 * dt;
  else if (goD()) p.speed -= 400 * dt;
  else p.speed -= 60 * dt;
  p.speed = Math.max(60, Math.min(380, p.speed));

  // Steer
  if (goL()) p.steerVel -= 380 * dt;
  else if (goR()) p.steerVel += 380 * dt;
  else p.steerVel *= (1 - 6 * dt);
  p.steerVel = Math.max(-260, Math.min(260, p.steerVel));
  p.x += p.steerVel * dt;
  p.tilt = p.steerVel / 200;

  // Road bounds
  const m = CAR_W / 2 + 3;
  if (p.x < ROAD_L + m) { p.x = ROAD_L + m; p.steerVel = Math.abs(p.steerVel) * 0.3; p.speed *= 0.88; addSparks(p.x, p.y, 3); }
  if (p.x > ROAD_R - m) { p.x = ROAD_R - m; p.steerVel = -Math.abs(p.steerVel) * 0.3; p.speed *= 0.88; addSparks(p.x, p.y, 3); }

  // Tire marks on hard turn
  if (Math.abs(p.tilt) > 0.5 && p.speed > 160) {
    tireMarks.push({ x: p.x - 5, y: p.y + 14, life: 2.5 });
    tireMarks.push({ x: p.x + 5, y: p.y + 14, life: 2.5 });
  }

  // Scroll
  roadScroll += p.speed * dt;

  // Runner AI — drives in lanes, makes deliberate lane changes
  r.swerveTimer -= dt;
  if (r.swerveTimer <= 0) {
    // Decide next move
    r.swerveTimer = 1.5 + Math.random() * 2.5;

    // Find current lane
    let curLane = 0, minD = 9999;
    for (let i = 0; i < LANE_COUNT; i++) {
      const d = Math.abs(r.x - laneX(i));
      if (d < minD) { minD = d; curLane = i; }
    }

    // Pick a lane: prefer staying, sometimes dodge away from player
    const playerClose = gapDist < 150;
    if (playerClose && Math.random() < 0.7) {
      // Dodge: pick lane furthest from player
      let bestLane = curLane, bestDist = 0;
      for (let i = 0; i < LANE_COUNT; i++) {
        const d = Math.abs(laneX(i) - p.x);
        if (d > bestDist) { bestDist = d; bestLane = i; }
      }
      // Don't jump more than 1 lane at a time
      if (bestLane > curLane) r.targetLane = Math.min(curLane + 1, LANE_COUNT - 1);
      else if (bestLane < curLane) r.targetLane = Math.max(curLane - 1, 0);
      else r.targetLane = curLane;
    } else {
      // Occasional random lane shift (1 lane max)
      const shift = Math.random() < 0.3 ? (Math.random() < 0.5 ? -1 : 1) : 0;
      r.targetLane = Math.max(0, Math.min(LANE_COUNT - 1, curLane + shift));
    }

    r.targetX = laneX(r.targetLane);
  }

  // Smooth lane change — fixed lateral speed, not proportional to error
  const err = r.targetX - r.x;
  const laneChangeSpeed = 80 + busts * 8; // pixels per second
  if (Math.abs(err) > 2) {
    r.x += Math.sign(err) * Math.min(Math.abs(err), laneChangeSpeed * dt);
    r.tilt = Math.sign(err) * Math.min(1, Math.abs(err) / 20);
  } else {
    r.x = r.targetX;
    r.tilt *= 0.85;
  }
  r.x = Math.max(ROAD_L + m, Math.min(ROAD_R - m, r.x));

  r.speed = r.baseSpeed + Math.sin(Date.now() * 0.003) * 10;

  // Visual Y
  const targetY = Math.max(TOP + 20, p.y - 140 - gapDist * 0.55);
  r.y += (targetY - r.y) * 4 * dt;

  // Gap
  gapDist += (r.speed - p.speed) * dt * 0.4;
  gapDist = Math.max(0, gapDist);
  if (gapDist >= MAX_GAP) { endGame(); return; }

  // Ram
  ramCooldown -= dt;
  const dx = p.x - r.x, dy = p.y - r.y;
  if (Math.abs(dx) < CAR_W && Math.abs(dy) < CAR_H * 0.9 && ramCooldown <= 0 && p.speed > 100) {
    ramCooldown = 1;
    busts++;
    const pts = 100 + busts * 50;
    score += pts;
    gapDist = 0;
    effects.push({ x: r.x, y: r.y, text: 'BUSTED +' + pts, color: '#F0A830', life: 2, size: 20 });
    addSparks(r.x, r.y, 14);
    flashTimer = 0.1;
    shakeTimer = 0.2;
    p.speed *= 0.5;
    setTimeout(() => {
      if (!gameRunning) return;
      runner = mkRunner(busts);
      effects.push({ x: W / 2, y: H * 0.35, text: 'NEW SUSPECT', color: '#ff5555', life: 2, size: 15 });
    }, 700);
  }

  // Civilians
  if (Math.random() < dt * (1.0 + busts * 0.2)) {
    const lane = Math.floor(Math.random() * LANE_COUNT);
    const up = lane < LANE_COUNT / 2;
    civilians.push({
      x: laneX(lane), y: up ? H + CAR_H : -CAR_H * 2,
      dir: up ? -1 : 1, speed: 50 + Math.random() * 40,
      col: CIV_COLS[Math.floor(Math.random() * CIV_COLS.length)],
      hit: false, tilt: 0,
    });
  }

  civilians.forEach(c => {
    c.y += c.dir * c.speed * dt + p.speed * 0.35 * dt;
    if (!c.hit && Math.abs(p.x - c.x) < CAR_W * 0.85 && Math.abs(p.y - c.y) < CAR_H * 0.8) {
      c.hit = true;
      p.speed *= 0.35;
      p.steerVel += (p.x - c.x) * 4;
      effects.push({ x: c.x, y: c.y, text: 'CRASH', color: '#ff4444', life: 1, size: 14 });
      addSparks((p.x + c.x) / 2, (p.y + c.y) / 2, 8);
      shakeTimer = 0.12;
      c.x += (c.x - p.x) * 2;
    }
  });
  civilians = civilians.filter(c => c.y > -120 && c.y < H + 120);

  // Fade/scroll
  tireMarks.forEach(tm => { tm.life -= dt; tm.y += p.speed * 0.35 * dt; });
  tireMarks = tireMarks.filter(tm => tm.life > 0 && tm.y < H + 20);
  sparks.forEach(s => { s.x += s.vx * dt; s.y += s.vy * dt; s.life -= dt; });
  sparks = sparks.filter(s => s.life > 0);
  effects.forEach(e => e.life -= dt * 0.6);
  effects = effects.filter(e => e.life > 0);
  if (shakeTimer > 0) { shakeX = (Math.random() - 0.5) * 5; shakeY = (Math.random() - 0.5) * 5; shakeTimer -= dt; }
  else { shakeX = 0; shakeY = 0; }

  // HUD
  document.getElementById('hudScore').textContent = score;
  document.getElementById('hudBusts').textContent = busts;
  document.getElementById('hudSpeed').textContent = Math.floor(p.speed);
  document.getElementById('hudDist').textContent = Math.floor(100 - gapDist / MAX_GAP * 100) + '%';
}

// ─── DRAW ───
function draw() {
  cx.clearRect(0, 0, W, H);
  cx.save();
  cx.translate(shakeX, shakeY);

  drawScene();

  // Civilians
  civilians.forEach(c => drawCar(c.x, c.y, CAR_W * 0.88, CAR_H * 0.85, c.tilt, c.col, false, false));

  // Runner
  if (runner) {
    drawCar(runner.x, runner.y, CAR_W, CAR_H, runner.tilt, RUNNER_COL, false, true);
    // Tail glow
    cx.fillStyle = 'rgba(255,50,50,0.06)';
    cx.beginPath(); cx.ellipse(runner.x, runner.y + CAR_H / 2 + 6, 12, 6, 0, 0, Math.PI * 2); cx.fill();
  }

  // Player
  if (player) {
    drawCar(player.x, player.y, CAR_W * 1.05, CAR_H, player.tilt, ICE_COL, true, false);
    // Headlight beams
    cx.save();
    cx.translate(player.x, player.y);
    const hlg = cx.createRadialGradient(0, -CAR_H, 4, 0, -CAR_H * 2.5, CAR_W * 1.5);
    hlg.addColorStop(0, 'rgba(255,255,230,0.08)');
    hlg.addColorStop(1, 'rgba(255,255,230,0)');
    cx.fillStyle = hlg;
    cx.beginPath();
    cx.moveTo(-5, -CAR_H / 2);
    cx.lineTo(-CAR_W * 1.3, -CAR_H * 3.5);
    cx.lineTo(CAR_W * 1.3, -CAR_H * 3.5);
    cx.lineTo(5, -CAR_H / 2);
    cx.closePath();
    cx.fill();
    cx.restore();
  }

  drawSparks();
  drawGapBar();
  drawEffects();

  // Touch hints
  if ('ontouchstart' in window && gameRunning) {
    cx.fillStyle = 'rgba(255,255,255,0.04)';
    cx.fillRect(0, H * 0.4, W * 0.28, H * 0.6);
    cx.fillRect(W * 0.72, H * 0.4, W * 0.28, H * 0.6);
    cx.fillStyle = 'rgba(255,255,255,0.08)';
    cx.font = '600 10px Oswald,sans-serif';
    cx.textAlign = 'center';
    cx.fillText('STEER', W * 0.14, H * 0.95);
    cx.fillText('STEER', W * 0.86, H * 0.95);
  }

  cx.restore();

  if (flashTimer > 0) {
    cx.fillStyle = `rgba(255,255,255,${flashTimer * 5})`;
    cx.fillRect(0, 0, W, H);
    flashTimer -= 0.016;
  }
}

// ─── LOOP ───
function loop(ts) {
  const dt = Math.min((ts - lastTime) / 1000, 0.05);
  lastTime = ts;
  update(dt);
  draw();
  requestAnimationFrame(loop);
}

// ─── START / END ───
function startGame() {
  score = 0; busts = 0; gapDist = 0; roadScroll = 0;
  player = mkPlayer();
  runner = mkRunner(0);
  civilians = []; tireMarks = []; effects = []; sparks = [];
  flashTimer = 0; ramCooldown = 0; shakeTimer = 0;
  genTrees();
  gameRunning = true;
  document.getElementById('hud').style.display = 'flex';
  document.getElementById('startScreen').classList.add('hidden');
  document.getElementById('gameOverScreen').classList.add('hidden');
}

function endGame() {
  gameRunning = false;
  document.getElementById('goTitle').textContent = 'Suspect Escaped';
  document.getElementById('goTitle').style.color = '#D32F2F';
  document.getElementById('goSub').textContent = `You busted ${busts} suspect${busts !== 1 ? 's' : ''} scoring ${score} points.`;
  document.getElementById('goStats').innerHTML = `
    <div class="stat-row"><span class="stat-label">Score</span><span class="stat-val">${score}</span></div>
    <div class="stat-row"><span class="stat-label">Busts</span><span class="stat-val">${busts}</span></div>`;
  document.getElementById('gameOverScreen').classList.remove('hidden');
}

function shareText() {
  return `ICE CHASE\n\nScore: ${score}\nBusts: ${busts}\n\nCan you catch more?\nufcr.online/ice-chase/`;
}

document.getElementById('startBtn').addEventListener('click', startGame);
document.getElementById('restartBtn').addEventListener('click', startGame);
document.getElementById('shareBtn').addEventListener('click', () => {
  window.open('https://x.com/intent/tweet?text=' + encodeURIComponent(shareText()), '_blank');
});
document.getElementById('copyBtn').addEventListener('click', () => {
  navigator.clipboard.writeText(shareText()).then(() => {
    document.getElementById('copyBtn').innerHTML = '<i class="fas fa-check"></i> Copied!';
    setTimeout(() => { document.getElementById('copyBtn').innerHTML = '<i class="fas fa-copy"></i> Copy'; }, 2000);
  });
});

requestAnimationFrame(loop);
</script>
</body>
</html>
