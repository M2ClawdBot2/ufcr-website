<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>ICE CHECKPOINT — UFCR Games</title>
  <link rel="icon" href="../assets/images/shield-logo.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Oswald:wght@500;600;700&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    :root{--orange:#FA4616;--gold:#F0A830;--navy:#001845;--dark:#0A0E1A;--red:#D32F2F;--green:#43A047;--blue:#2558a0;--font-body:'Inter',sans-serif;--font-heading:'Oswald',sans-serif;--font-doc:'Courier Prime',monospace}
    *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
    html,body{width:100%;height:100%;overflow:hidden;font-family:var(--font-body);background:var(--dark);color:#fff;-webkit-tap-highlight-color:transparent;user-select:none}
    .nav{position:fixed;top:0;left:0;right:0;z-index:100;height:44px;background:rgba(0,24,69,.95);backdrop-filter:blur(20px);border-bottom:1px solid rgba(255,255,255,.06);display:flex;align-items:center;justify-content:space-between;padding:0 12px}
    .nav-logo{display:flex;align-items:center;gap:6px;text-decoration:none;color:#fff}
    .nav-logo img{height:26px;border-radius:3px;background:#fff;padding:1px}
    .nav-logo span{font-family:var(--font-heading);font-size:.95rem;font-weight:700;letter-spacing:.08em}
    .nav-back{font-size:.65rem;color:rgba(255,255,255,.5);text-decoration:none;letter-spacing:.1em;text-transform:uppercase;font-weight:600}

    /* HUD */
    .hud{position:fixed;top:44px;left:0;right:0;z-index:90;display:none;justify-content:space-between;padding:6px 12px;background:rgba(0,24,69,.85);backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,255,255,.05)}
    .hud-item{text-align:center;flex:1}
    .hud-label{font-size:.45rem;text-transform:uppercase;letter-spacing:.15em;color:rgba(255,255,255,.3)}
    .hud-value{font-family:var(--font-heading);font-size:1rem;font-weight:700}
    .hud-value.score{color:var(--gold)}.hud-value.day{color:#7cf}.hud-value.strikes{color:var(--red)}.hud-value.queue{color:var(--orange)}

    /* Game area */
    #gameArea{position:fixed;top:0;left:0;right:0;bottom:0;display:none;flex-direction:column}
    
    /* Scene - top portion showing booth — front-facing view */
    #scene{flex:0 0 35%;min-height:150px;max-height:500px;background:#87CEEB;position:relative;overflow:hidden;border-bottom:3px solid #444}
    @media (min-width:641px){#scene{flex:0 0 45%}}
    
    /* Document inspection area */
    #deskArea{flex:1;background:#3a2a1a;position:relative;overflow:hidden;display:flex;flex-direction:column}
    #desk{flex:1;position:relative;overflow:auto;padding:12px;display:flex;gap:12px;flex-wrap:wrap;align-content:flex-start;justify-content:center;-webkit-overflow-scrolling:touch}
    @media (min-width:641px){#desk{padding:20px 30px;gap:20px}}
    
    /* Action buttons */
    #actions{display:flex;gap:0;height:64px;flex-shrink:0}
    #actions button{flex:1;border:none;font-family:var(--font-heading);font-size:1.1rem;font-weight:700;letter-spacing:.12em;text-transform:uppercase;cursor:pointer;transition:all .15s;color:#fff}
    #btnAdmit{background:#2d8a3e}
    #btnAdmit:active{background:#1e6b2e}
    #btnDetain{background:#c62828}
    #btnDetain:active{background:#a01c1c}
    #btnAdmit:disabled,#btnDetain:disabled{opacity:.3;pointer-events:none}

    /* Documents */
    .doc{background:#f5f0e0;color:#1a1a1a;border:1px solid #c8c0a8;padding:14px 16px;font-family:var(--font-doc);font-size:.75rem;line-height:1.6;min-width:170px;max-width:260px;position:relative;cursor:pointer;transition:transform .2s,box-shadow .2s;flex-shrink:0;box-shadow:2px 2px 8px rgba(0,0,0,.3)}
    @media (min-width:641px){.doc{padding:18px 20px;font-size:.85rem;min-width:220px;max-width:300px}}
    .doc:hover{transform:translateY(-2px);box-shadow:2px 4px 12px rgba(0,0,0,.4)}
    .doc.zoomed{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(1.8);z-index:200;max-width:240px;box-shadow:0 0 60px rgba(0,0,0,.7)}
    .doc-header{font-family:var(--font-heading);font-size:.65rem;font-weight:700;letter-spacing:.15em;text-transform:uppercase;color:#1a4a8a;border-bottom:1px solid #bbb8a0;padding-bottom:4px;margin-bottom:8px;text-align:center}
    .doc-field{margin-bottom:4px}
    .doc-label{font-size:.55rem;color:#888;text-transform:uppercase;letter-spacing:.1em}
    .doc-val{font-weight:700;font-size:.72rem}
    @media (min-width:641px){.doc-header{font-size:.8rem;margin-bottom:10px}.doc-field{margin-bottom:6px}.doc-label{font-size:.65rem}.doc-val{font-size:.88rem}}
    .doc-seal{position:absolute;bottom:8px;right:8px;width:30px;height:30px;border:2px solid rgba(26,74,138,.25);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.4rem;color:rgba(26,74,138,.3);font-family:var(--font-heading);font-weight:700;letter-spacing:.05em;text-transform:uppercase}
    .doc-photo{width:36px;height:44px;background:#ddd;border:1px solid #bbb;float:right;margin:0 0 6px 8px;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .doc-watermark{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) rotate(-30deg);font-family:var(--font-heading);font-size:1.2rem;font-weight:700;letter-spacing:.2em;text-transform:uppercase;color:rgba(26,74,138,.06);pointer-events:none;white-space:nowrap}
    .doc-expired .doc-header{color:#a03030}
    .doc-flag{position:absolute;top:4px;right:4px;background:var(--red);color:#fff;font-size:.45rem;padding:1px 5px;font-family:var(--font-heading);font-weight:700;letter-spacing:.1em;display:none}

    /* Rulebook */
    #rulebook{position:fixed;top:44px;left:0;bottom:0;width:280px;background:rgba(10,14,26,.97);border-right:1px solid rgba(255,255,255,.08);z-index:150;transform:translateX(-100%);transition:transform .3s ease;padding:60px 16px 16px;overflow-y:auto;-webkit-overflow-scrolling:touch}
    #rulebook.open{transform:translateX(0)}
    #ruleToggle{position:fixed;top:54px;left:8px;z-index:160;background:rgba(0,24,69,.8);border:1px solid rgba(255,255,255,.1);color:#fff;width:32px;height:32px;display:none;align-items:center;justify-content:center;cursor:pointer;font-size:.8rem}
    .rule-title{font-family:var(--font-heading);font-size:.75rem;font-weight:700;letter-spacing:.2em;text-transform:uppercase;color:var(--gold);margin-bottom:12px}
    .rule-item{font-size:.75rem;color:rgba(255,255,255,.6);margin-bottom:8px;padding-left:12px;position:relative;line-height:1.5}
    .rule-item::before{content:'';position:absolute;left:0;top:6px;width:5px;height:5px;background:var(--orange);border-radius:50%}
    .rule-new{color:var(--gold);font-weight:600}

    /* Briefing overlay */
    .overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(5,8,18,.94);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:200;padding:24px;text-align:center}
    .overlay.hidden{display:none}
    .overlay-label{font-family:var(--font-heading);font-size:.7rem;font-weight:600;letter-spacing:.3em;text-transform:uppercase;color:var(--gold);margin-bottom:8px}
    .overlay-title{font-family:var(--font-heading);font-size:clamp(2rem,7vw,3.5rem);font-weight:700;text-transform:uppercase;margin-bottom:8px;letter-spacing:.03em}
    .overlay-sub{font-size:.85rem;color:rgba(255,255,255,.4);margin-bottom:20px;max-width:400px;line-height:1.6}
    .overlay-rules{text-align:left;max-width:380px;margin-bottom:24px}
    .overlay-rules li{font-size:.8rem;color:rgba(255,255,255,.6);margin-bottom:6px;line-height:1.5;list-style:none;padding-left:16px;position:relative}
    .overlay-rules li::before{content:'';position:absolute;left:0;top:7px;width:5px;height:5px;background:var(--orange);border-radius:50%}
    .overlay-rules li.new-rule{color:var(--gold);font-weight:600}
    .btn{font-family:var(--font-heading);font-size:1rem;font-weight:600;letter-spacing:.12em;text-transform:uppercase;background:var(--orange);color:#fff;border:none;padding:12px 32px;cursor:pointer;transition:all .3s}
    .btn:hover{background:#e03a0e}
    .btn-sm{font-size:.8rem;padding:8px 20px}
    .stats-grid{min-width:220px;margin-bottom:20px}
    .stat-row{display:flex;justify-content:space-between;font-size:.85rem;padding:5px 0;border-bottom:1px solid rgba(255,255,255,.05)}
    .stat-label{color:rgba(255,255,255,.35)}.stat-val{font-weight:700;color:var(--gold)}
    .share-btns{display:flex;gap:10px;margin-top:12px}
    .share-btn{font-family:var(--font-heading);font-size:.65rem;font-weight:600;letter-spacing:.1em;text-transform:uppercase;padding:8px 14px;border:1px solid rgba(255,255,255,.12);background:transparent;color:#fff;cursor:pointer;display:flex;align-items:center;gap:5px;transition:all .3s}
    .share-btn:hover{background:rgba(255,255,255,.06)}

    /* Zoom backdrop */
    #zoomBackdrop{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:190;display:none}

    /* Result flash */
    .result-flash{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:180;font-family:var(--font-heading);font-size:2rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;pointer-events:none;animation:flashIn .6s ease forwards}
    @keyframes flashIn{0%{opacity:0;transform:translate(-50%,-50%) scale(1.5)}30%{opacity:1;transform:translate(-50%,-50%) scale(1)}100%{opacity:0;transform:translate(-50%,-50%) scale(1) translateY(-20px)}}

    /* How-to list */
    .how-to{max-width:380px;margin-bottom:20px;text-align:left}
    .how-to li{font-size:.8rem;color:rgba(255,255,255,.5);margin-bottom:5px;line-height:1.5;list-style:none;padding-left:16px;position:relative}
    .how-to li::before{content:'';position:absolute;left:0;top:7px;width:5px;height:5px;background:var(--orange);border-radius:50%}
  </style>
</head>
<body>

<nav class="nav">
  <a href="../" class="nav-logo"><img src="../assets/images/shield-logo.png" alt="UFCR"><span>UFCR</span></a>
  <a href="../games/" class="nav-back"><i class="fas fa-arrow-left"></i> Games</a>
</nav>

<!-- START SCREEN -->
<div class="overlay" id="startScreen">
  <div class="overlay-label">UFCR Games</div>
  <div class="overlay-title" style="color:var(--orange)">ICE CHECKPOINT</div>
  <p class="overlay-sub">You're an ICE agent at a border checkpoint. Inspect documents. Spot forgeries. Admit or detain. Don't let fakes through.</p>
  <ul class="how-to">
    <li>Cars pull up — inspect their documents</li>
    <li>Tap a document to zoom in</li>
    <li>Check for expired dates, wrong info, missing watermarks</li>
    <li>New rules added each day — check the rulebook</li>
    <li>3 strikes and you're fired</li>
  </ul>
  <button class="btn" id="startBtn">Start Shift</button>
</div>

<!-- DAY BRIEFING -->
<div class="overlay hidden" id="briefScreen">
  <div class="overlay-label" id="briefLabel">Day 1</div>
  <div class="overlay-title" id="briefTitle">Morning Briefing</div>
  <p class="overlay-sub" id="briefSub"></p>
  <ul class="overlay-rules" id="briefRules"></ul>
  <button class="btn" id="briefBtn">Begin Shift</button>
</div>

<!-- GAME OVER -->
<div class="overlay hidden" id="gameOverScreen">
  <div class="overlay-label">Shift Over</div>
  <div class="overlay-title" id="goTitle" style="color:var(--red)">Fired</div>
  <p class="overlay-sub" id="goSub"></p>
  <div class="stats-grid" id="goStats"></div>
  <button class="btn" id="restartBtn">New Shift</button>
  <div class="share-btns">
    <button class="share-btn" id="shareBtn"><i class="fab fa-x-twitter"></i> Share</button>
    <button class="share-btn" id="copyBtn"><i class="fas fa-copy"></i> Copy</button>
  </div>
</div>

<!-- GAME AREA -->
<div id="gameArea">
  <div class="hud" id="hud">
    <div class="hud-item"><div class="hud-label">Score</div><div class="hud-value score" id="hudScore">0</div></div>
    <div class="hud-item"><div class="hud-label">Day</div><div class="hud-value day" id="hudDay">1</div></div>
    <div class="hud-item"><div class="hud-label">Strikes</div><div class="hud-value strikes" id="hudStrikes">0/3</div></div>
    <div class="hud-item"><div class="hud-label">Queue</div><div class="hud-value queue" id="hudQueue">0</div></div>
  </div>

  <canvas id="scene"></canvas>
  
  <div id="deskArea">
    <div id="desk"></div>
    <div id="actions">
      <button id="btnAdmit" disabled><i class="fas fa-check"></i> Admit</button>
      <button id="btnDetain" disabled><i class="fas fa-ban"></i> Detain</button>
    </div>
  </div>
</div>

<button id="ruleToggle"><i class="fas fa-book"></i></button>
<div id="rulebook">
  <div class="rule-title">Today's Rules</div>
  <div id="ruleList"></div>
</div>

<div id="zoomBackdrop"></div>

<script>
// ─── CANVAS ───
const sceneCanvas = document.getElementById('scene');
const sc = sceneCanvas.getContext('2d');
let SW, SH, sdpr;

function resizeScene() {
  sdpr = window.devicePixelRatio || 1;
  const rect = sceneCanvas.getBoundingClientRect();
  SW = rect.width; SH = rect.height;
  sceneCanvas.width = SW * sdpr; sceneCanvas.height = SH * sdpr;
  sc.setTransform(sdpr, 0, 0, sdpr, 0, 0);
}

// ─── DATA ───
// Names by demographic
const NAMES_WHITE = {
  first: ['Jake','Emily','Connor','Madison','Tyler','Hannah','Brett','Ashley','Cody','Sarah','Dylan','Lauren','Hunter','Megan','Kyle','Brittany','Travis','Kayla','Dustin','Amber','Chad','Tiffany','Brandon','Jessica','Ryan'],
  last: ['Smith','Johnson','Williams','Brown','Davis','Miller','Wilson','Anderson','Thomas','Taylor','Moore','Jackson','Martin','Lee','Thompson','White','Harris','Clark','Lewis','Robinson','Walker','Young','King','Wright','Hill']
};
const NAMES_HISPANIC = {
  first: ['Jose','Maria','Carlos','Sofia','Miguel','Elena','Diego','Ana','Luis','Carmen','Pedro','Rosa','Juan','Lucia','Roberto','Isabel','Alejandro','Valentina','Fernando','Gabriela','Marco','Patricia','Raul','Andrea','Oscar'],
  last: ['Garcia','Rodriguez','Martinez','Lopez','Hernandez','Gonzalez','Perez','Sanchez','Ramirez','Torres','Flores','Rivera','Gomez','Diaz','Cruz','Morales','Reyes','Gutierrez','Ortiz','Ramos','Mendoza','Castillo','Vargas','Romero','Alvarez']
};
const NAMES_BLACK = {
  first: ['Darius','Aaliyah','Jamal','Keisha','DeShawn','Tamika','Tyrone','Ebony','Marcus','Jasmine','Andre','Destiny','Terrell','Imani','Malik','Shaniqua','Dante','Latoya','Jerome','Aisha','Lamar','Monique','Cedric','Tiana','Khalil'],
  last: ['Washington','Jefferson','Jackson','Robinson','Freeman','Banks','Coleman','Brooks','Reed','Hayes','Powell','Butler','Sanders','Price','Howard','Jenkins','Perry','Russell','Bell','Grant','Dixon','Simmons','Marshall','Owens','Wallace']
};
const STATES = ['Texas','California','Arizona','New Mexico','Florida','Nevada','Colorado','Georgia','North Carolina','Illinois'];
const STATE_ABBR = {Texas:'TX',California:'CA',Arizona:'AZ','New Mexico':'NM',Florida:'FL',Nevada:'NV',Colorado:'CO',Georgia:'GA','North Carolina':'NC',Illinois:'IL'};
const OFFICES = ['El Paso','San Diego','Tucson','Laredo','McAllen','Nogales','Brownsville','Del Rio','Eagle Pass','Yuma'];
const FAKE_OFFICES = ['Puerto Verde','San Marcos Sur','Rio Nuevo','Costa Linda','Playa Norte'];
const EMPLOYERS = ['Del Sol Farms','Rio Grande Logistics','Mesa Construction','Valley Fresh Produce','Sunbelt Textiles','Border Steel Co','Southwest Packing','Lone Star Dairy','Pacific Harvest','Gulf Coast Marine'];
const FAKE_EMPLOYERS = ['Phantom LLC','Nowhere Corp','XYZ Holdings','ABC Services Inc'];
const CAR_COLORS = ['#cc2828','#2255aa','#228833','#aa8822','#666','#884488','#cc6622','#2288aa'];
const CAR_NAMES = ['Sedan','Pickup','SUV','Hatchback','Van','Coupe'];
const SKIN_TONES_WHITE = ['#f1c27d','#e8b98a','#f5d0a9','#edd3b8','#dbb99b'];
const SKIN_TONES_HISPANIC = ['#c68642','#d2996c','#cd853f','#b8763a','#d4a76a'];
const SKIN_TONES_BLACK = ['#8d5524','#6b3a1f','#a0522d','#7a4420','#5c3317'];
const DEMOGRAPHICS = ['white','white','white','hispanic','hispanic','hispanic','black','black']; // weighted distribution
const HAIR_COLORS = ['#1a1a1a','#3b2314','#5a3825','#2c1608','#4a3000'];
const HAIR_STYLES = ['short','bald','long','medium'];

// ─── GAME STATE ───
let gameRunning = false;
let day = 0, score = 0, strikes = 0, streak = 0;
let totalCorrect = 0, totalWrong = 0;
let carsToday = 0, carsProcessed = 0;
let currentPerson = null;
// Animation states: idle, driving-in, barrier-up, waiting, barrier-up-out, driving-out, u-turn, driving-away
let animState = 'idle';
let carY = 0, carTargetY = 0; // Y position (distance from viewer)
let carXOff = 0; // X offset for turning
let carAngle = 0; // rotation for u-turn
let barrierAngle = 0; // 0 = down, 1 = up
let animTimer = 0;
let allRules = [];
let zoomedDoc = null;

// Scene animation
let sceneFrame = 0;
let lastDecision = 'admit'; // track for animation

// ─── RULES SYSTEM ───
const DAY_CONFIGS = [
  {
    day: 1,
    title: 'First Day',
    sub: 'Welcome to the checkpoint, agent. Start simple — check IDs and registrations.',
    cars: 6,
    forgeChance: 0.35,
    newRules: [
      'All drivers must have a valid Driver\'s License (not expired)',
      'Vehicle Registration must match the car at the checkpoint',
    ],
    forgeTypes: ['expired_license','wrong_plate'],
  },
  {
    day: 2,
    title: 'Tightening Up',
    sub: 'We\'re seeing more fakes. Stay sharp.',
    cars: 7,
    forgeChance: 0.4,
    newRules: [
      'Name must match across ALL documents',
      'Photo on license must match the driver',
    ],
    forgeTypes: ['expired_license','wrong_plate','name_mismatch','wrong_photo'],
  },
  {
    day: 3,
    title: 'New Requirements',
    sub: 'HQ has added travel visa checks for non-citizens.',
    cars: 8,
    forgeChance: 0.45,
    newRules: [
      'Non-citizen travelers must have a valid Travel Visa',
      'Visa issuing office must be a recognized port of entry',
    ],
    forgeTypes: ['expired_license','wrong_plate','name_mismatch','wrong_photo','expired_visa','fake_office'],
  },
  {
    day: 4,
    title: 'Intel Alert',
    sub: 'Forged Texas licenses have been circulating. Check watermarks carefully.',
    cars: 9,
    forgeChance: 0.5,
    newRules: [
      'ALERT: Texas licenses must show "LONE STAR" watermark',
      'Check license state abbreviation matches the state name',
    ],
    forgeTypes: ['expired_license','wrong_plate','name_mismatch','wrong_photo','expired_visa','fake_office','missing_watermark','wrong_state_abbr'],
  },
  {
    day: 5,
    title: 'Work Permits',
    sub: 'All workers must now present employment authorization.',
    cars: 10,
    forgeChance: 0.5,
    newRules: [
      'Workers must carry a valid Work Permit',
      'Employer must be a registered company (watch for fakes)',
    ],
    forgeTypes: ['expired_license','wrong_plate','name_mismatch','wrong_photo','expired_visa','fake_office','missing_watermark','wrong_state_abbr','expired_work_permit','fake_employer'],
  },
  {
    day: 6,
    title: 'Crackdown',
    sub: 'Multiple forgery rings busted. Expect sophisticated fakes.',
    cars: 10,
    forgeChance: 0.55,
    newRules: [
      'Registration VIN must be exactly 6 digits',
      'Dates must use MM/DD/YYYY format — reject DD/MM/YYYY',
    ],
    forgeTypes: ['expired_license','wrong_plate','name_mismatch','wrong_photo','expired_visa','fake_office','missing_watermark','wrong_state_abbr','expired_work_permit','fake_employer','bad_vin','wrong_date_format'],
  },
  {
    day: 7,
    title: 'Zero Tolerance',
    sub: 'Every document scrutinized. No mistakes.',
    cars: 12,
    forgeChance: 0.6,
    newRules: [
      'All previous rules remain in effect',
      'Multiple forgeries may appear on a single person',
    ],
    forgeTypes: ['expired_license','wrong_plate','name_mismatch','wrong_photo','expired_visa','fake_office','missing_watermark','wrong_state_abbr','expired_work_permit','fake_employer','bad_vin','wrong_date_format'],
  },
];

function getDayConfig() {
  if (day <= DAY_CONFIGS.length) return DAY_CONFIGS[day - 1];
  // Endless mode after day 7
  const base = DAY_CONFIGS[DAY_CONFIGS.length - 1];
  return { ...base, day, cars: 12 + (day - 7) * 2, forgeChance: Math.min(0.75, 0.6 + (day - 7) * 0.03), newRules: ['Vigilance is paramount. Trust nothing.'], title: 'Day ' + day, sub: 'The fakes keep coming. Stay sharp.' };
}

// ─── PERSON GENERATOR ───
function randEl(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
function randInt(a, b) { return Math.floor(Math.random() * (b - a + 1)) + a; }

function genDate(yearMin, yearMax, monthMin, monthMax) {
  const y = randInt(yearMin, yearMax);
  const m = randInt(monthMin || 1, monthMax || 12);
  const d = randInt(1, 28);
  return { m, d, y, str: pad(m) + '/' + pad(d) + '/' + y };
}
function pad(n) { return n < 10 ? '0' + n : '' + n; }

function genPlate() {
  const letters = 'ABCDEFGHJKLMNPRSTUVWXYZ';
  return randEl(letters) + randEl(letters) + randEl(letters) + '-' + randInt(1000, 9999);
}

function genVIN() { return '' + randInt(100000, 999999); }

function genFace(demo) {
  const skinMap = { white: SKIN_TONES_WHITE, hispanic: SKIN_TONES_HISPANIC, black: SKIN_TONES_BLACK };
  return {
    skin: randEl(skinMap[demo] || SKIN_TONES_WHITE),
    hair: randEl(HAIR_COLORS),
    hairStyle: randEl(HAIR_STYLES),
    eyeY: randInt(-1, 1),
    mouthW: randInt(4, 8),
    noseH: randInt(2, 4),
    demo,
  };
}

function genPerson() {
  const cfg = getDayConfig();
  const isForgery = Math.random() < cfg.forgeChance;
  
  const demo = randEl(DEMOGRAPHICS);
  const nameSet = demo === 'hispanic' ? NAMES_HISPANIC : demo === 'black' ? NAMES_BLACK : NAMES_WHITE;
  const firstName = randEl(nameSet.first);
  const lastName = randEl(nameSet.last);
  const name = firstName + ' ' + lastName;
  const state = randEl(STATES);
  const abbr = STATE_ABBR[state];
  const isCitizen = demo === 'hispanic' ? Math.random() > 0.55 : Math.random() > 0.3;
  const isWorker = !isCitizen && Math.random() > 0.4;
  const face = genFace(demo);
  const carColor = randEl(CAR_COLORS);
  const carType = randEl(CAR_NAMES);
  const plate = genPlate();
  const vin = genVIN();

  const licExpiry = genDate(2027, 2031);
  const visaExpiry = genDate(2027, 2030);
  const workExpiry = genDate(2027, 2030);
  const office = randEl(OFFICES);
  const employer = randEl(EMPLOYERS);

  const person = {
    name, firstName, lastName, state, abbr, face, isCitizen, isWorker,
    carColor, carType, plate, vin,
    licExpiry, visaExpiry, workExpiry, office, employer,
    forgeries: [],
    docs: [],
  };

  // Build documents
  const licData = { type: 'license', name, state, abbr, expiry: licExpiry.str, photo: { ...face }, watermark: state === 'Texas' ? 'LONE STAR' : state.toUpperCase() };
  const regData = { type: 'registration', name, carType, carColor, plate, vin, state };
  
  person.docs.push(licData);
  person.docs.push(regData);

  if (!isCitizen && day >= 3) {
    person.docs.push({ type: 'visa', name, expiry: visaExpiry.str, office, country: randEl(['Mexico','Guatemala','Honduras','El Salvador','Colombia','Venezuela','Brazil','Ecuador']) });
  }
  if (isWorker && day >= 5) {
    person.docs.push({ type: 'work_permit', name, expiry: workExpiry.str, employer });
  }

  // Apply forgeries
  if (isForgery) {
    const available = cfg.forgeTypes.filter(f => canApplyForge(f, person));
    if (available.length > 0) {
      // 1-2 forgeries on harder days
      const count = day >= 7 && Math.random() > 0.6 ? 2 : 1;
      const shuffled = available.sort(() => Math.random() - 0.5);
      for (let i = 0; i < Math.min(count, shuffled.length); i++) {
        applyForgery(shuffled[i], person);
      }
    }
  }

  return person;
}

function canApplyForge(type, p) {
  switch (type) {
    case 'expired_license': return true;
    case 'wrong_plate': return true;
    case 'name_mismatch': return p.docs.length > 1;
    case 'wrong_photo': return true;
    case 'expired_visa': return p.docs.some(d => d.type === 'visa');
    case 'fake_office': return p.docs.some(d => d.type === 'visa');
    case 'missing_watermark': return p.state === 'Texas';
    case 'wrong_state_abbr': return true;
    case 'expired_work_permit': return p.docs.some(d => d.type === 'work_permit');
    case 'fake_employer': return p.docs.some(d => d.type === 'work_permit');
    case 'bad_vin': return true;
    case 'wrong_date_format': return true;
    default: return false;
  }
}

function applyForgery(type, p) {
  p.forgeries.push(type);
  switch (type) {
    case 'expired_license': {
      const exp = genDate(2020, 2025);
      exp.y = randInt(2020, 2025);
      exp.str = pad(exp.m) + '/' + pad(exp.d) + '/' + exp.y;
      p.docs.find(d => d.type === 'license').expiry = exp.str;
      break;
    }
    case 'wrong_plate': {
      p.docs.find(d => d.type === 'registration').plate = genPlate(); // different from actual
      break;
    }
    case 'name_mismatch': {
      // Change name on a random non-first doc
      const otherDocs = p.docs.filter((d, i) => i > 0);
      if (otherDocs.length) {
        const d = randEl(otherDocs);
        d.name = randEl(FIRST_NAMES) + ' ' + randEl(LAST_NAMES);
      }
      break;
    }
    case 'wrong_photo': {
      // Different face on license — same demographic so it's subtle
      p.docs.find(d => d.type === 'license').photo = genFace(p.face?.demo || randEl(DEMOGRAPHICS));
      break;
    }
    case 'expired_visa': {
      const v = p.docs.find(d => d.type === 'visa');
      if (v) { v.expiry = pad(randInt(1,12)) + '/' + pad(randInt(1,28)) + '/' + randInt(2020, 2025); }
      break;
    }
    case 'fake_office': {
      const v = p.docs.find(d => d.type === 'visa');
      if (v) v.office = randEl(FAKE_OFFICES);
      break;
    }
    case 'missing_watermark': {
      p.docs.find(d => d.type === 'license').watermark = '';
      break;
    }
    case 'wrong_state_abbr': {
      const lic = p.docs.find(d => d.type === 'license');
      const wrongAbbrs = Object.values(STATE_ABBR).filter(a => a !== p.abbr);
      lic.abbr = randEl(wrongAbbrs);
      break;
    }
    case 'expired_work_permit': {
      const w = p.docs.find(d => d.type === 'work_permit');
      if (w) { w.expiry = pad(randInt(1,12)) + '/' + pad(randInt(1,28)) + '/' + randInt(2020, 2025); }
      break;
    }
    case 'fake_employer': {
      const w = p.docs.find(d => d.type === 'work_permit');
      if (w) w.employer = randEl(FAKE_EMPLOYERS);
      break;
    }
    case 'bad_vin': {
      const reg = p.docs.find(d => d.type === 'registration');
      reg.vin = '' + randInt(10000, 99999); // 5 digits instead of 6
      break;
    }
    case 'wrong_date_format': {
      // Swap DD/MM on a random doc date
      const docs = p.docs.filter(d => d.expiry);
      if (docs.length) {
        const d = randEl(docs);
        const parts = d.expiry.split('/');
        d.expiry = parts[1] + '/' + parts[0] + '/' + parts[2]; // swap MM and DD
        // Only a forgery if DD > 12 (otherwise ambiguous — be fair)
        // Actually let's make it obvious by ensuring day > 12
        const newDay = randInt(13, 28);
        d.expiry = pad(newDay) + '/' + parts[0] + '/' + parts[2];
      }
      break;
    }
  }
}

// ─── RENDER DOCUMENTS ───
function renderDocs(person) {
  const desk = document.getElementById('desk');
  desk.innerHTML = '';
  
  person.docs.forEach((doc, i) => {
    const el = document.createElement('div');
    el.className = 'doc';
    el.innerHTML = renderDocHTML(doc, person);
    el.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleZoom(el);
    });
    desk.appendChild(el);
  });

  document.getElementById('btnAdmit').disabled = false;
  document.getElementById('btnDetain').disabled = false;
}

function renderDocHTML(doc, person) {
  switch (doc.type) {
    case 'license': return `
      <div class="doc-watermark">${doc.watermark || ''}</div>
      <div class="doc-header">${doc.state} Driver's License</div>
      <div class="doc-photo" id="photoHolder">${drawFaceHTML(doc.photo)}</div>
      <div class="doc-field"><div class="doc-label">Name</div><div class="doc-val">${doc.name}</div></div>
      <div class="doc-field"><div class="doc-label">State</div><div class="doc-val">${doc.state} (${doc.abbr})</div></div>
      <div class="doc-field"><div class="doc-label">Expires</div><div class="doc-val">${doc.expiry}</div></div>
      <div class="doc-seal">${doc.abbr}</div>`;
    case 'registration': return `
      <div class="doc-header">Vehicle Registration</div>
      <div class="doc-field"><div class="doc-label">Owner</div><div class="doc-val">${doc.name}</div></div>
      <div class="doc-field"><div class="doc-label">Plate</div><div class="doc-val">${doc.plate}</div></div>
      <div class="doc-field"><div class="doc-label">VIN</div><div class="doc-val">${doc.vin}</div></div>
      <div class="doc-field"><div class="doc-label">State</div><div class="doc-val">${doc.state}</div></div>
      <div class="doc-seal">DMV</div>`;
    case 'visa': return `
      <div class="doc-watermark">TRAVEL VISA</div>
      <div class="doc-header">U.S. Travel Visa</div>
      <div class="doc-field"><div class="doc-label">Name</div><div class="doc-val">${doc.name}</div></div>
      <div class="doc-field"><div class="doc-label">Country of Origin</div><div class="doc-val">${doc.country}</div></div>
      <div class="doc-field"><div class="doc-label">Issuing Office</div><div class="doc-val">${doc.office}</div></div>
      <div class="doc-field"><div class="doc-label">Expires</div><div class="doc-val">${doc.expiry}</div></div>
      <div class="doc-seal">DHS</div>`;
    case 'work_permit': return `
      <div class="doc-watermark">WORK PERMIT</div>
      <div class="doc-header">Employment Authorization</div>
      <div class="doc-field"><div class="doc-label">Name</div><div class="doc-val">${doc.name}</div></div>
      <div class="doc-field"><div class="doc-label">Employer</div><div class="doc-val">${doc.employer}</div></div>
      <div class="doc-field"><div class="doc-label">Expires</div><div class="doc-val">${doc.expiry}</div></div>
      <div class="doc-seal">USCIS</div>`;
    default: return '';
  }
}

function drawFaceHTML(face) {
  // Simple SVG face
  const h = face.hairStyle;
  let hairSVG = '';
  if (h === 'short') hairSVG = `<rect x="8" y="4" width="20" height="6" rx="3" fill="${face.hair}"/>`;
  else if (h === 'long') hairSVG = `<rect x="6" y="4" width="24" height="14" rx="4" fill="${face.hair}"/>`;
  else if (h === 'medium') hairSVG = `<rect x="7" y="4" width="22" height="9" rx="3" fill="${face.hair}"/>`;
  
  return `<svg viewBox="0 0 36 44" width="36" height="44">
    <rect x="0" y="0" width="36" height="44" fill="#eee"/>
    ${hairSVG}
    <ellipse cx="18" cy="22" rx="11" ry="14" fill="${face.skin}"/>
    <circle cx="13" cy="${19 + face.eyeY}" r="1.8" fill="#1a1a1a"/>
    <circle cx="23" cy="${19 + face.eyeY}" r="1.8" fill="#1a1a1a"/>
    <ellipse cx="18" cy="${25 + face.noseH * 0.3}" rx="2" ry="${face.noseH * 0.5}" fill="rgba(0,0,0,0.1)"/>
    <line x1="${18 - face.mouthW/2}" y1="30" x2="${18 + face.mouthW/2}" y2="30" stroke="#4a2a1a" stroke-width="1.2" stroke-linecap="round"/>
  </svg>`;
}

function toggleZoom(el) {
  const backdrop = document.getElementById('zoomBackdrop');
  if (zoomedDoc === el) {
    el.classList.remove('zoomed');
    backdrop.style.display = 'none';
    zoomedDoc = null;
  } else {
    if (zoomedDoc) zoomedDoc.classList.remove('zoomed');
    el.classList.add('zoomed');
    backdrop.style.display = 'block';
    zoomedDoc = el;
  }
}

document.getElementById('zoomBackdrop').addEventListener('click', () => {
  if (zoomedDoc) {
    zoomedDoc.classList.remove('zoomed');
    zoomedDoc = null;
  }
  document.getElementById('zoomBackdrop').style.display = 'none';
});

// ─── DRAW SCENE (FRONT-FACING PERSPECTIVE) ───
function drawScene() {
  sc.clearRect(0, 0, SW, SH);
  const cx = SW / 2;
  const sceneSc = Math.min(1, SH / 280); // global scale for small scenes

  // Sky gradient
  const skyGrad = sc.createLinearGradient(0, 0, 0, SH * 0.32);
  skyGrad.addColorStop(0, '#4A90D4');
  skyGrad.addColorStop(1, '#8EC5E8');
  sc.fillStyle = skyGrad;
  sc.fillRect(0, 0, SW, SH * 0.32);

  // Clouds
  sc.fillStyle = 'rgba(255,255,255,0.5)';
  [[SW*0.2, SH*0.08, 35], [SW*0.6, SH*0.12, 25], [SW*0.85, SH*0.06, 20]].forEach(([x,y,r]) => {
    sc.beginPath(); sc.ellipse(x, y, r, r*0.4, 0, 0, Math.PI*2); sc.fill();
    sc.beginPath(); sc.ellipse(x-r*0.5, y+2, r*0.6, r*0.3, 0, 0, Math.PI*2); sc.fill();
    sc.beginPath(); sc.ellipse(x+r*0.6, y+1, r*0.5, r*0.3, 0, 0, Math.PI*2); sc.fill();
  });

  // Sun
  sc.fillStyle = 'rgba(255,250,200,0.4)';
  sc.beginPath(); sc.arc(SW * 0.85, SH * 0.08, 28, 0, Math.PI * 2); sc.fill();
  sc.fillStyle = '#fff8cc';
  sc.beginPath(); sc.arc(SW * 0.85, SH * 0.08, 16, 0, Math.PI * 2); sc.fill();

  // Mountains (layered)
  sc.fillStyle = '#7a9a6a';
  sc.beginPath();
  sc.moveTo(0, SH * 0.32);
  sc.lineTo(SW*0.08, SH*0.18); sc.lineTo(SW*0.2, SH*0.28);
  sc.lineTo(SW*0.35, SH*0.13); sc.lineTo(SW*0.5, SH*0.26);
  sc.lineTo(SW*0.65, SH*0.16); sc.lineTo(SW*0.8, SH*0.24);
  sc.lineTo(SW*0.92, SH*0.19); sc.lineTo(SW, SH*0.22);
  sc.lineTo(SW, SH*0.32); sc.closePath(); sc.fill();
  // Closer hills
  sc.fillStyle = '#8ab07a';
  sc.beginPath();
  sc.moveTo(0, SH*0.32); sc.lineTo(SW*0.15, SH*0.26);
  sc.lineTo(SW*0.4, SH*0.3); sc.lineTo(SW*0.6, SH*0.25);
  sc.lineTo(SW*0.85, SH*0.3); sc.lineTo(SW, SH*0.28);
  sc.lineTo(SW, SH*0.32); sc.closePath(); sc.fill();

  // Desert ground
  const groundY = SH * 0.32;
  const grdGrad = sc.createLinearGradient(0, groundY, 0, SH);
  grdGrad.addColorStop(0, '#d8c898');
  grdGrad.addColorStop(1, '#c4b080');
  sc.fillStyle = grdGrad;
  sc.fillRect(0, groundY, SW, SH - groundY);

  // Small desert bushes
  sc.fillStyle = '#7a9055';
  [[SW*0.08, groundY+20], [SW*0.92, groundY+25], [SW*0.05, SH*0.7], [SW*0.95, SH*0.6]].forEach(([x,y]) => {
    sc.beginPath(); sc.ellipse(x, y, 8, 5, 0, 0, Math.PI*2); sc.fill();
  });

  // ─── Road (perspective) ───
  const roadTopW = SW * 0.22;
  const roadBotW = SW * 0.65;
  const roadTop = groundY;
  const roadBot = SH;

  // Road shadow
  sc.fillStyle = 'rgba(0,0,0,0.06)';
  sc.beginPath();
  sc.moveTo(cx - roadTopW/2 - 8, roadTop);
  sc.lineTo(cx + roadTopW/2 + 8, roadTop);
  sc.lineTo(cx + roadBotW/2 + 12, roadBot);
  sc.lineTo(cx - roadBotW/2 - 12, roadBot);
  sc.closePath(); sc.fill();

  // Road surface
  const roadGrad = sc.createLinearGradient(0, roadTop, 0, roadBot);
  roadGrad.addColorStop(0, '#505050');
  roadGrad.addColorStop(1, '#3a3a3a');
  sc.fillStyle = roadGrad;
  sc.beginPath();
  sc.moveTo(cx - roadTopW/2, roadTop);
  sc.lineTo(cx + roadTopW/2, roadTop);
  sc.lineTo(cx + roadBotW/2, roadBot);
  sc.lineTo(cx - roadBotW/2, roadBot);
  sc.closePath(); sc.fill();

  // Edge lines
  sc.strokeStyle = 'rgba(255,255,255,0.6)';
  sc.lineWidth = 2;
  sc.beginPath(); sc.moveTo(cx - roadTopW/2 + 2, roadTop); sc.lineTo(cx - roadBotW/2 + 4, roadBot); sc.stroke();
  sc.beginPath(); sc.moveTo(cx + roadTopW/2 - 2, roadTop); sc.lineTo(cx + roadBotW/2 - 4, roadBot); sc.stroke();

  // Center dashes (perspective sized)
  sc.strokeStyle = '#cc0';
  for (let i = 0; i < 10; i++) {
    const t1 = i / 10;
    const t2 = (i + 0.35) / 10;
    sc.lineWidth = 1.5 + t1 * 1.5;
    sc.beginPath();
    sc.moveTo(cx, roadTop + (roadBot - roadTop) * t1);
    sc.lineTo(cx, roadTop + (roadBot - roadTop) * t2);
    sc.stroke();
  }

  // ─── Booth (left side, scaled to scene) ───
  const boothW = Math.min(70, SW * 0.15) * sceneSc + 20;
  const boothH = SH * 0.42;
  const boothX = cx - roadBotW * 0.35;
  const boothY = SH - boothH;

  // Booth shadow
  sc.fillStyle = 'rgba(0,0,0,0.12)';
  sc.beginPath(); sc.roundRect(boothX + 3, boothY + 3, boothW, boothH, 2); sc.fill();

  // Booth body
  const boothGrad = sc.createLinearGradient(boothX, boothY, boothX + boothW, boothY);
  boothGrad.addColorStop(0, '#e8e4dc');
  boothGrad.addColorStop(0.5, '#f0ece4');
  boothGrad.addColorStop(1, '#ddd8d0');
  sc.fillStyle = boothGrad;
  sc.beginPath(); sc.roundRect(boothX, boothY, boothW, boothH, [3,3,0,0]); sc.fill();

  // Booth roof (overhang)
  sc.fillStyle = '#4a4a4a';
  sc.beginPath(); sc.roundRect(boothX - 8, boothY - 6, boothW + 16, 10, 2); sc.fill();
  sc.fillStyle = '#5a5a5a';
  sc.fillRect(boothX - 6, boothY - 3, boothW + 12, 3);

  // Window
  const winX = boothX + 8, winY = boothY + 14;
  const winW = boothW - 16, winH = boothH * 0.28;
  sc.fillStyle = 'rgba(70,150,200,0.5)';
  sc.beginPath(); sc.roundRect(winX, winY, winW, winH, 2); sc.fill();
  // Window reflection
  sc.fillStyle = 'rgba(255,255,255,0.1)';
  sc.beginPath();
  sc.moveTo(winX + 2, winY + 2);
  sc.lineTo(winX + winW * 0.3, winY + 2);
  sc.lineTo(winX + 2, winY + winH * 0.5);
  sc.closePath(); sc.fill();
  // Window frame
  sc.strokeStyle = '#777';
  sc.lineWidth = 2;
  sc.strokeRect(winX, winY, winW, winH);
  sc.beginPath(); sc.moveTo(winX + winW/2, winY); sc.lineTo(winX + winW/2, winY + winH); sc.stroke();

  // Counter/ledge below window
  sc.fillStyle = '#bbb5a8';
  sc.fillRect(boothX + 4, winY + winH, boothW - 8, 6);

  // Door hint
  sc.fillStyle = '#ccc8bc';
  sc.beginPath(); sc.roundRect(boothX + boothW * 0.3, boothY + boothH * 0.55, boothW * 0.4, boothH * 0.4, 2); sc.fill();
  sc.strokeStyle = '#aaa8a0';
  sc.lineWidth = 1;
  sc.strokeRect(boothX + boothW * 0.3, boothY + boothH * 0.55, boothW * 0.4, boothH * 0.4);
  // Door handle
  sc.fillStyle = '#888';
  sc.fillRect(boothX + boothW * 0.62, boothY + boothH * 0.73, 5, 2);

  // Sign
  const signW = boothW + 24;
  sc.fillStyle = '#152d6b';
  sc.beginPath(); sc.roundRect(boothX - 12, boothY - 30, signW, 22, 3); sc.fill();
  // Sign border
  sc.strokeStyle = '#fff';
  sc.lineWidth = 1;
  sc.beginPath(); sc.roundRect(boothX - 10, boothY - 28, signW - 4, 18, 2); sc.stroke();
  sc.fillStyle = '#fff';
  sc.font = `700 ${Math.max(9, Math.min(13, boothW * 0.13))}px Oswald,sans-serif`;
  sc.textAlign = 'center';
  sc.fillText('ICE CHECKPOINT', boothX + boothW / 2, boothY - 15);

  // ─── Barrier gate (animated) ───
  const gatePostX = boothX + boothW + 2;
  const gateBaseY = SH * 0.55;
  const gateArmLen = cx + roadBotW * 0.25 - gatePostX;
  // Post
  sc.fillStyle = '#777';
  sc.fillRect(gatePostX - 3, gateBaseY - 45, 6, 50);
  sc.fillStyle = '#888';
  sc.beginPath(); sc.arc(gatePostX, gateBaseY - 45, 5, 0, Math.PI * 2); sc.fill();
  // Arm (rotates around pivot at post top — positive angle lifts up)
  sc.save();
  sc.translate(gatePostX, gateBaseY - 43);
  // When barrierAngle=0: arm is horizontal (blocked). When 1: arm points up (open).
  // We rotate clockwise by 90 degrees to lift. The arm extends to the right,
  // so rotating negatively (counter-clockwise) makes it go UP.
  sc.rotate(-barrierAngle * Math.PI * 0.45); // 0=horizontal, 1=~80 degrees up
  sc.fillStyle = '#e44';
  sc.beginPath(); sc.roundRect(0, -3, gateArmLen, 6, 2); sc.fill();
  sc.fillStyle = '#fff';
  for (let i = 12; i < gateArmLen - 5; i += 18) {
    sc.fillRect(i, -3, 8, 6);
  }
  // Counterweight
  sc.fillStyle = '#666';
  sc.beginPath(); sc.roundRect(-15, -5, 16, 10, 3); sc.fill();
  sc.restore();

  // ─── Traffic cones (only on edges, small) ───
  for (let i = 0; i < 3; i++) {
    const t = 0.5 + i * 0.15;
    const cy_ = roadTop + (roadBot - roadTop) * t;
    const spread = (roadTopW / 2) + (roadBotW / 2 - roadTopW / 2) * t;
    const coneScale = (0.3 + t * 0.4) * sceneSc;
    drawCone(cx - spread + 4, cy_, coneScale);
    drawCone(cx + spread - 4, cy_, coneScale);
  }

  // ─── Car ───
  if (currentPerson && animState !== 'idle') {
    drawCarFront(cx + roadBotW * 0.1 + carXOff, carY, carAngle);
  }

  // ─── ICE Van ───
  drawICEVan(cx + roadBotW * 0.42, SH * 0.42);
}

function drawCone(x, y, s) {
  s = s || 1;
  sc.fillStyle = '#ff6600';
  sc.beginPath();
  sc.moveTo(x, y - 10*s);
  sc.lineTo(x - 6*s, y + 3*s);
  sc.lineTo(x + 6*s, y + 3*s);
  sc.closePath(); sc.fill();
  sc.fillStyle = '#fff';
  sc.fillRect(x - 4*s, y - 3*s, 8*s, 2.5*s);
  sc.fillStyle = '#dd5500';
  sc.beginPath(); sc.roundRect(x - 7*s, y + 2*s, 14*s, 3*s, 1); sc.fill();
}

function drawCarFront(x, animY, angle) {
  const col = currentPerson.carColor;
  const face = currentPerson.face;

  // Perspective scale — responsive to scene size
  const minY = SH * 0.32, maxY = SH * 0.65;
  const t = Math.max(0, Math.min(1, (animY - minY) / (maxY - minY)));
  const sceneSc = Math.min(1, SH / 300);
  const scale = (0.25 + t * 0.45) * sceneSc;
  const w = 130 * scale;
  const h = 155 * scale;

  sc.save();
  sc.translate(x, animY);
  if (angle) sc.rotate(angle);

  // Shadow
  sc.fillStyle = 'rgba(0,0,0,0.18)';
  sc.beginPath(); sc.ellipse(3, h*0.49, w*0.52, h*0.05, 0, 0, Math.PI*2); sc.fill();

  // ─── Lower body ───
  sc.fillStyle = col;
  sc.beginPath(); sc.roundRect(-w/2, -h*0.08, w, h*0.58, [0,0, 6*scale, 6*scale]); sc.fill();

  // ─── Hood (sloped panel on top of lower body) ───
  sc.fillStyle = shadeColor(col, 18);
  sc.beginPath();
  sc.moveTo(-w*0.46, -h*0.08);
  sc.lineTo(-w*0.38, -h*0.2);
  sc.lineTo(w*0.38, -h*0.2);
  sc.lineTo(w*0.46, -h*0.08);
  sc.closePath(); sc.fill();
  // Hood highlight
  sc.fillStyle = 'rgba(255,255,255,0.06)';
  sc.beginPath();
  sc.moveTo(-w*0.2, -h*0.18);
  sc.lineTo(w*0.2, -h*0.18);
  sc.lineTo(w*0.15, -h*0.09);
  sc.lineTo(-w*0.15, -h*0.09);
  sc.closePath(); sc.fill();

  // ─── Grille ───
  sc.fillStyle = '#282828';
  sc.beginPath(); sc.roundRect(-w*0.34, -h*0.09, w*0.68, h*0.06, 3*scale); sc.fill();
  // Chrome trim
  sc.strokeStyle = 'rgba(200,200,200,0.3)';
  sc.lineWidth = 1;
  sc.beginPath(); sc.roundRect(-w*0.34, -h*0.09, w*0.68, h*0.06, 3*scale); sc.stroke();
  // Slats
  sc.fillStyle = '#3a3a3a';
  for (let i = 0; i < 6; i++) {
    const sx = -w*0.3 + i * w*0.105;
    sc.fillRect(sx, -h*0.085, w*0.07, h*0.045);
  }

  // ─── Headlights (more detailed) ───
  // Housing
  sc.fillStyle = '#e8e0cc';
  sc.beginPath(); sc.roundRect(-w/2 + 2*scale, -h*0.13, w*0.18, h*0.08, [4*scale, 2*scale, 2*scale, 4*scale]); sc.fill();
  sc.beginPath(); sc.roundRect(w/2 - 2*scale - w*0.18, -h*0.13, w*0.18, h*0.08, [2*scale, 4*scale, 4*scale, 2*scale]); sc.fill();
  // Bulb glow
  sc.fillStyle = '#fff8dd';
  sc.beginPath(); sc.arc(-w/2 + 2*scale + w*0.09, -h*0.09, 4*scale, 0, Math.PI*2); sc.fill();
  sc.beginPath(); sc.arc(w/2 - 2*scale - w*0.09, -h*0.09, 4*scale, 0, Math.PI*2); sc.fill();
  // Reflector
  sc.fillStyle = 'rgba(255,255,230,0.3)';
  sc.beginPath(); sc.arc(-w/2 + 2*scale + w*0.09, -h*0.09, 2.5*scale, 0, Math.PI*2); sc.fill();
  sc.beginPath(); sc.arc(w/2 - 2*scale - w*0.09, -h*0.09, 2.5*scale, 0, Math.PI*2); sc.fill();

  // ─── Fog lights ───
  sc.fillStyle = 'rgba(255,255,200,0.25)';
  sc.beginPath(); sc.arc(-w*0.28, -h*0.015, 2.5*scale, 0, Math.PI*2); sc.fill();
  sc.beginPath(); sc.arc(w*0.28, -h*0.015, 2.5*scale, 0, Math.PI*2); sc.fill();

  // ─── Windshield ───
  const wsGrad = sc.createLinearGradient(0, -h*0.38, 0, -h*0.15);
  wsGrad.addColorStop(0, 'rgba(100,170,220,0.65)');
  wsGrad.addColorStop(1, 'rgba(130,190,230,0.4)');
  sc.fillStyle = wsGrad;
  sc.beginPath();
  sc.moveTo(-w*0.4, -h*0.18);
  sc.lineTo(-w*0.33, -h*0.38);
  sc.lineTo(w*0.33, -h*0.38);
  sc.lineTo(w*0.4, -h*0.18);
  sc.closePath(); sc.fill();
  // Windshield reflection
  sc.fillStyle = 'rgba(255,255,255,0.08)';
  sc.beginPath();
  sc.moveTo(-w*0.35, -h*0.35);
  sc.lineTo(-w*0.15, -h*0.35);
  sc.lineTo(-w*0.25, -h*0.2);
  sc.lineTo(-w*0.38, -h*0.2);
  sc.closePath(); sc.fill();
  // A-pillars
  sc.strokeStyle = shadeColor(col, -25);
  sc.lineWidth = 3.5 * scale;
  sc.lineCap = 'round';
  sc.beginPath(); sc.moveTo(-w*0.39, -h*0.19); sc.lineTo(-w*0.32, -h*0.37); sc.stroke();
  sc.beginPath(); sc.moveTo(w*0.39, -h*0.19); sc.lineTo(w*0.32, -h*0.37); sc.stroke();

  // ─── Driver ───
  if (scale > 0.5) {
    const ds = scale * 0.85;
    sc.save();
    sc.translate(w * 0.06, -h * 0.26);
    // Shoulders/shirt
    sc.fillStyle = ['#445566','#554433','#335544','#553344','#444444'][Math.floor(face.mouthW) % 5];
    sc.beginPath(); sc.ellipse(0, 14*ds, 15*ds, 9*ds, 0, -Math.PI, 0); sc.fill();
    // Neck
    sc.fillStyle = face.skin;
    sc.fillRect(-3*ds, 5*ds, 6*ds, 8*ds);
    // Head
    sc.beginPath(); sc.ellipse(0, 0, 10*ds, 13*ds, 0, 0, Math.PI*2); sc.fill();
    // Ears
    sc.beginPath(); sc.ellipse(-10*ds, 0, 2.5*ds, 4*ds, 0, 0, Math.PI*2); sc.fill();
    sc.beginPath(); sc.ellipse(10*ds, 0, 2.5*ds, 4*ds, 0, 0, Math.PI*2); sc.fill();
    // Hair
    if (face.hairStyle !== 'bald') {
      sc.fillStyle = face.hair;
      if (face.hairStyle === 'long') {
        sc.beginPath(); sc.ellipse(0, -7*ds, 12*ds, 9*ds, 0, 0, Math.PI*2); sc.fill();
        sc.fillRect(-11*ds, -4*ds, 22*ds, 8*ds);
      } else if (face.hairStyle === 'medium') {
        sc.beginPath(); sc.ellipse(0, -8*ds, 11*ds, 7*ds, 0, 0, Math.PI*2); sc.fill();
      } else {
        sc.beginPath(); sc.ellipse(0, -9*ds, 10*ds, 5*ds, 0, 0, Math.PI*2); sc.fill();
      }
    }
    // Eyes
    sc.fillStyle = '#fff';
    sc.beginPath(); sc.ellipse(-4*ds, (-1+face.eyeY)*ds, 2.5*ds, 2*ds, 0, 0, Math.PI*2); sc.fill();
    sc.beginPath(); sc.ellipse(4*ds, (-1+face.eyeY)*ds, 2.5*ds, 2*ds, 0, 0, Math.PI*2); sc.fill();
    sc.fillStyle = '#1a1a1a';
    sc.beginPath(); sc.arc(-4*ds, (-1+face.eyeY)*ds, 1.3*ds, 0, Math.PI*2); sc.fill();
    sc.beginPath(); sc.arc(4*ds, (-1+face.eyeY)*ds, 1.3*ds, 0, Math.PI*2); sc.fill();
    // Nose
    sc.fillStyle = shadeColor(face.skin, -15);
    sc.beginPath(); sc.ellipse(0, 3*ds, 2*ds, face.noseH*0.5*ds, 0, 0, Math.PI*2); sc.fill();
    // Mouth
    sc.strokeStyle = shadeColor(face.skin, -40);
    sc.lineWidth = 1.2*ds;
    sc.lineCap = 'round';
    sc.beginPath();
    sc.moveTo(-face.mouthW/2*ds, 7*ds);
    sc.quadraticCurveTo(0, 8.5*ds, face.mouthW/2*ds, 7*ds);
    sc.stroke();
    sc.restore();
  }

  // ─── Roof ───
  sc.fillStyle = shadeColor(col, -28);
  sc.beginPath();
  sc.moveTo(-w*0.33, -h*0.38);
  sc.lineTo(-w*0.28, -h*0.47);
  sc.lineTo(w*0.28, -h*0.47);
  sc.lineTo(w*0.33, -h*0.38);
  sc.closePath(); sc.fill();
  // Roof highlight
  sc.fillStyle = 'rgba(255,255,255,0.04)';
  sc.fillRect(-w*0.15, -h*0.46, w*0.3, h*0.07);

  // ─── Side mirrors ───
  sc.fillStyle = shadeColor(col, -12);
  sc.beginPath();
  sc.moveTo(-w/2, -h*0.14);
  sc.lineTo(-w/2 - 7*scale, -h*0.1);
  sc.lineTo(-w/2 - 7*scale, -h*0.04);
  sc.lineTo(-w/2, -h*0.02);
  sc.closePath(); sc.fill();
  sc.beginPath();
  sc.moveTo(w/2, -h*0.14);
  sc.lineTo(w/2 + 7*scale, -h*0.1);
  sc.lineTo(w/2 + 7*scale, -h*0.04);
  sc.lineTo(w/2, -h*0.02);
  sc.closePath(); sc.fill();
  // Mirror glass
  sc.fillStyle = 'rgba(100,160,200,0.4)';
  sc.fillRect(-w/2 - 6*scale, -h*0.1, 5*scale, 5*scale);
  sc.fillRect(w/2 + 1*scale, -h*0.1, 5*scale, 5*scale);

  // ─── Bumper ───
  sc.fillStyle = '#3a3a3a';
  sc.beginPath(); sc.roundRect(-w/2 + 1*scale, h*0.44, w - 2*scale, h*0.06, [0,0, 4*scale, 4*scale]); sc.fill();
  // Bumper chrome strip
  sc.fillStyle = 'rgba(200,200,200,0.15)';
  sc.fillRect(-w*0.4, h*0.455, w*0.8, 1.5*scale);

  // ─── License plate ───
  const plateW = Math.max(w * 0.5, 50 * scale);
  const plateH = Math.max(h * 0.09, 12 * scale);
  const plateY = h * 0.36;
  sc.fillStyle = '#f8f8f0';
  sc.beginPath(); sc.roundRect(-plateW/2, plateY, plateW, plateH, 2*scale); sc.fill();
  sc.strokeStyle = '#aaa';
  sc.lineWidth = 0.8;
  sc.strokeRect(-plateW/2, plateY, plateW, plateH);
  // Plate text — measure and fit
  const plateFontSize = Math.max(6, Math.min(12 * scale, plateW * 0.12));
  sc.fillStyle = '#1a1a1a';
  sc.font = `700 ${plateFontSize}px monospace`;
  sc.textAlign = 'center';
  sc.textBaseline = 'middle';
  sc.fillText(currentPerson.plate, 0, plateY + plateH / 2);
  sc.textBaseline = 'alphabetic';

  // ─── Wheels ───
  // Wheel wells (dark)
  sc.fillStyle = '#1a1a1a';
  sc.beginPath(); sc.ellipse(-w/2 + 6*scale, h*0.47, 12*scale, 6*scale, 0, 0, Math.PI*2); sc.fill();
  sc.beginPath(); sc.ellipse(w/2 - 6*scale, h*0.47, 12*scale, 6*scale, 0, 0, Math.PI*2); sc.fill();
  // Tires
  sc.fillStyle = '#2a2a2a';
  sc.beginPath(); sc.ellipse(-w/2 + 6*scale, h*0.47, 10*scale, 5*scale, 0, 0, Math.PI*2); sc.fill();
  sc.beginPath(); sc.ellipse(w/2 - 6*scale, h*0.47, 10*scale, 5*scale, 0, 0, Math.PI*2); sc.fill();
  // Hubcaps
  sc.fillStyle = '#888';
  sc.beginPath(); sc.arc(-w/2 + 6*scale, h*0.47, 4.5*scale, 0, Math.PI*2); sc.fill();
  sc.beginPath(); sc.arc(w/2 - 6*scale, h*0.47, 4.5*scale, 0, Math.PI*2); sc.fill();
  // Hubcap detail
  sc.fillStyle = '#aaa';
  sc.beginPath(); sc.arc(-w/2 + 6*scale, h*0.47, 2*scale, 0, Math.PI*2); sc.fill();
  sc.beginPath(); sc.arc(w/2 - 6*scale, h*0.47, 2*scale, 0, Math.PI*2); sc.fill();

  sc.restore();
}

function drawICEVan(x, y) {
  const s = 0.4 * Math.min(1, SH / 250);
  sc.save();
  sc.translate(x, y);
  sc.scale(s, s);

  // Shadow
  sc.fillStyle = 'rgba(0,0,0,0.15)';
  sc.beginPath(); sc.ellipse(2, 38, 32, 6, 0, 0, Math.PI*2); sc.fill();

  // Van body
  sc.fillStyle = '#2862b5';
  sc.beginPath(); sc.roundRect(-32, -30, 64, 68, 4); sc.fill();
  // Lower darker
  sc.fillStyle = '#1e4a8a';
  sc.beginPath(); sc.roundRect(-30, 10, 60, 26, [0,0,3,3]); sc.fill();
  // Body line
  sc.strokeStyle = 'rgba(255,255,255,0.1)';
  sc.lineWidth = 1;
  sc.beginPath(); sc.moveTo(-30, 8); sc.lineTo(30, 8); sc.stroke();

  // Windshield
  const wsG = sc.createLinearGradient(0, -28, 0, -14);
  wsG.addColorStop(0, 'rgba(100,170,230,0.6)');
  wsG.addColorStop(1, 'rgba(120,180,240,0.4)');
  sc.fillStyle = wsG;
  sc.beginPath();
  sc.moveTo(-24, -16); sc.lineTo(-20, -28); sc.lineTo(20, -28); sc.lineTo(24, -16);
  sc.closePath(); sc.fill();

  // Grille
  sc.fillStyle = '#333';
  sc.beginPath(); sc.roundRect(-22, 24, 44, 8, 2); sc.fill();
  // Headlights
  sc.fillStyle = '#fff8cc';
  sc.beginPath(); sc.roundRect(-30, 22, 10, 6, 2); sc.fill();
  sc.beginPath(); sc.roundRect(20, 22, 10, 6, 2); sc.fill();

  // ICE text
  sc.fillStyle = 'rgba(255,255,255,0.8)';
  sc.font = '700 12px Oswald,sans-serif';
  sc.textAlign = 'center';
  sc.fillText('ICE', 0, 4);

  // Light bar
  sc.fillStyle = '#3a3a3a';
  sc.beginPath(); sc.roundRect(-15, -34, 30, 6, 2); sc.fill();
  const f = Math.sin(Date.now() * 0.012);
  sc.fillStyle = f > 0 ? '#ff2222' : '#2244ff';
  sc.beginPath(); sc.roundRect(-13, -33, 11, 4, 1); sc.fill();
  sc.fillStyle = f > 0 ? '#2244ff' : '#ff2222';
  sc.beginPath(); sc.roundRect(2, -33, 11, 4, 1); sc.fill();
  // Glow
  sc.fillStyle = f > 0 ? 'rgba(255,30,30,0.08)' : 'rgba(30,60,255,0.08)';
  sc.beginPath(); sc.arc(0, -31, 28, 0, Math.PI*2); sc.fill();

  // Bumper
  sc.fillStyle = '#3a3a3a';
  sc.beginPath(); sc.roundRect(-28, 34, 56, 4, 2); sc.fill();
  sc.restore();
}

function shadeColor(hex, amt) {
  let r = parseInt(hex.slice(1,3),16) + amt;
  let g = parseInt(hex.slice(3,5),16) + amt;
  let b = parseInt(hex.slice(5,7),16) + amt;
  r = Math.max(0,Math.min(255,r)); g = Math.max(0,Math.min(255,g)); b = Math.max(0,Math.min(255,b));
  return '#' + [r,g,b].map(c => c.toString(16).padStart(2,'0')).join('');
}

// ─── ANIMATION LOOP ───
function sceneLoop() {
  if (!gameRunning) return;
  resizeScene();
  
  // Animate car + barrier
  if (animState === 'driving-in') {
    carY += (carTargetY - carY) * 0.06;
    if (Math.abs(carY - carTargetY) < 1.5) {
      carY = carTargetY;
      animState = 'waiting';
      renderDocs(currentPerson);
    }
  } else if (animState === 'barrier-up-out') {
    // Lift barrier quickly and visibly
    barrierAngle = Math.min(1, barrierAngle + 0.06);
    if (barrierAngle >= 1) {
      animState = lastDecision === 'admit' ? 'driving-out' : 'driving-detained';
      animTimer = 0;
    }
  } else if (animState === 'driving-out') {
    // Admitted: car drives TOWARD us (grows bigger), veers right, exits off screen
    animTimer++;
    carY += 4; // drive toward camera (gets bigger)
    if (animTimer > 15) {
      carXOff += 5 + animTimer * 0.3; // start veering right
      carAngle -= 0.015; // slight turn
    }
    if (carXOff > SW * 0.6 || carY > SH + 50) {
      animState = 'barrier-down';
    }
  } else if (animState === 'driving-detained') {
    // Detained: car drives away but veers LEFT toward ICE van area
    animTimer++;
    carY -= 2.5;
    carXOff += 4; // veer right toward the ICE van side
    carAngle -= 0.02; // slight turn angle
    if (carY < SH * 0.25) {
      animState = 'barrier-down';
    }
  } else if (animState === 'barrier-down') {
    barrierAngle = Math.max(0, barrierAngle - 0.06);
    if (barrierAngle <= 0) {
      animState = 'idle';
      nextCar();
    }
  }

  drawScene();
  sceneFrame = requestAnimationFrame(sceneLoop);
}

// ─── GAME FLOW ───
function startGame() {
  day = 0; score = 0; strikes = 0; streak = 0;
  totalCorrect = 0; totalWrong = 0;
  allRules = [];
  barrierAngle = 0; carY = 0; carXOff = 0; carAngle = 0; animTimer = 0;
  document.getElementById('startScreen').classList.add('hidden');
  document.getElementById('gameOverScreen').classList.add('hidden');
  document.getElementById('gameArea').style.display = 'flex';
  document.getElementById('hud').style.display = 'flex';
  document.getElementById('ruleToggle').style.display = 'flex';
  gameRunning = true;
  resizeScene();
  nextDay();
  sceneLoop();
}

function nextDay() {
  day++;
  const cfg = getDayConfig();
  carsToday = cfg.cars;
  carsProcessed = 0;

  // Add new rules
  cfg.newRules.forEach(r => allRules.push(r));
  
  // Show briefing
  document.getElementById('briefLabel').textContent = 'Day ' + day;
  document.getElementById('briefTitle').textContent = cfg.title;
  document.getElementById('briefSub').textContent = cfg.sub;
  
  const rulesList = document.getElementById('briefRules');
  rulesList.innerHTML = '';
  allRules.forEach((r, i) => {
    const li = document.createElement('li');
    li.textContent = r;
    if (i >= allRules.length - cfg.newRules.length) li.className = 'new-rule';
    rulesList.appendChild(li);
  });

  updateRulebook();
  document.getElementById('briefScreen').classList.remove('hidden');
  updateHUD();
}

function updateRulebook() {
  const list = document.getElementById('ruleList');
  list.innerHTML = '';
  const cfg = getDayConfig();
  allRules.forEach((r, i) => {
    const div = document.createElement('div');
    div.className = 'rule-item' + (i >= allRules.length - cfg.newRules.length ? ' rule-new' : '');
    div.textContent = r;
    list.appendChild(div);
  });
}

function beginShift() {
  document.getElementById('briefScreen').classList.add('hidden');
  nextCar();
}

function nextCar() {
  if (carsProcessed >= carsToday) {
    // Day complete
    nextDay();
    return;
  }
  
  const desk = document.getElementById('desk');
  desk.innerHTML = '<div style="color:rgba(255,255,255,.3);font-size:.8rem;padding:20px;text-align:center">Vehicle approaching...</div>';
  document.getElementById('btnAdmit').disabled = true;
  document.getElementById('btnDetain').disabled = true;

  currentPerson = genPerson();
  carY = SH * 0.2; // start far away (small)
  carTargetY = SH * 0.55; // stop at booth — not too close
  carXOff = 0;
  carAngle = 0;
  animState = 'driving-in';
  updateHUD();
}

function makeDecision(admit) {
  if (!currentPerson || animState !== 'waiting') return;
  
  const isFake = currentPerson.forgeries.length > 0;
  const correct = (admit && !isFake) || (!admit && isFake);

  document.getElementById('btnAdmit').disabled = true;
  document.getElementById('btnDetain').disabled = true;

  // Close zoom
  if (zoomedDoc) {
    zoomedDoc.classList.remove('zoomed');
    zoomedDoc = null;
    document.getElementById('zoomBackdrop').style.display = 'none';
  }

  carsProcessed++;

  if (correct) {
    totalCorrect++;
    streak++;
    const pts = (admit ? 10 : 25) + (streak > 2 ? streak * 5 : 0);
    score += pts;
    showFlash(admit ? 'ADMITTED' : 'DETAINED', '#4CAF50', '+' + pts);
  } else {
    totalWrong++;
    streak = 0;
    strikes++;
    const penalty = admit ? -50 : -20;
    score = Math.max(0, score + penalty);
    
    // Show what was wrong
    let reason = '';
    if (admit && isFake) {
      reason = 'FORGERY: ' + currentPerson.forgeries.map(describeForgery).join(', ');
    } else {
      reason = 'Documents were legitimate!';
    }
    showFlash('WRONG', '#f44', penalty + ' pts | ' + reason);
  }

  updateHUD();

  if (strikes >= 3) {
    setTimeout(() => endGame(), 1200);
    animState = 'idle';
    return;
  }

  // Barrier up, then car drives out
  lastDecision = admit ? 'admit' : 'detain';
  animState = 'barrier-up-out';
}

function describeForgery(type) {
  const map = {
    expired_license: 'Expired license',
    wrong_plate: 'Plate mismatch',
    name_mismatch: 'Name mismatch',
    wrong_photo: 'Photo doesn\'t match',
    expired_visa: 'Expired visa',
    fake_office: 'Fake issuing office',
    missing_watermark: 'Missing watermark',
    wrong_state_abbr: 'Wrong state abbreviation',
    expired_work_permit: 'Expired work permit',
    fake_employer: 'Fake employer',
    bad_vin: 'Invalid VIN',
    wrong_date_format: 'Wrong date format',
  };
  return map[type] || type;
}

function showFlash(text, color, sub) {
  const el = document.createElement('div');
  el.className = 'result-flash';
  el.style.color = color;
  el.innerHTML = text + (sub ? `<div style="font-size:.8rem;color:rgba(255,255,255,.5);margin-top:4px">${sub}</div>` : '');
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 800);
}

function updateHUD() {
  document.getElementById('hudScore').textContent = score;
  document.getElementById('hudDay').textContent = day;
  document.getElementById('hudStrikes').textContent = strikes + '/3';
  document.getElementById('hudStrikes').style.color = strikes >= 2 ? '#f44' : strikes >= 1 ? '#fa4' : '#fff';
  document.getElementById('hudQueue').textContent = Math.max(0, carsToday - carsProcessed);
}

function endGame() {
  gameRunning = false;
  cancelAnimationFrame(sceneFrame);
  
  const dayWord = day === 1 ? '1 day' : day + ' days';
  document.getElementById('goTitle').textContent = strikes >= 3 ? 'Fired' : 'Shift Over';
  document.getElementById('goTitle').style.color = strikes >= 3 ? '#D32F2F' : 'var(--gold)';
  document.getElementById('goSub').textContent = `You lasted ${dayWord} and processed ${totalCorrect + totalWrong} vehicles.`;
  document.getElementById('goStats').innerHTML = `
    <div class="stat-row"><span class="stat-label">Score</span><span class="stat-val">${score}</span></div>
    <div class="stat-row"><span class="stat-label">Days Survived</span><span class="stat-val">${day}</span></div>
    <div class="stat-row"><span class="stat-label">Correct Calls</span><span class="stat-val">${totalCorrect}</span></div>
    <div class="stat-row"><span class="stat-label">Wrong Calls</span><span class="stat-val">${totalWrong}</span></div>
    <div class="stat-row"><span class="stat-label">Best Streak</span><span class="stat-val">${streak}</span></div>`;
  document.getElementById('gameOverScreen').classList.remove('hidden');
}

function shareText() {
  return `ICE CHECKPOINT\n\nDay ${day} | Score: ${score}\nCorrect: ${totalCorrect} | Wrong: ${totalWrong}\n\nCan you survive longer?\nufcr.online/ice-checkpoint/`;
}

// ─── EVENT LISTENERS ───
document.getElementById('startBtn').addEventListener('click', startGame);
document.getElementById('briefBtn').addEventListener('click', beginShift);
document.getElementById('restartBtn').addEventListener('click', startGame);
document.getElementById('btnAdmit').addEventListener('click', () => makeDecision(true));
document.getElementById('btnDetain').addEventListener('click', () => makeDecision(false));

document.getElementById('ruleToggle').addEventListener('click', () => {
  document.getElementById('rulebook').classList.toggle('open');
});

document.getElementById('shareBtn').addEventListener('click', () => {
  window.open('https://x.com/intent/tweet?text=' + encodeURIComponent(shareText()), '_blank');
});
document.getElementById('copyBtn').addEventListener('click', () => {
  navigator.clipboard.writeText(shareText()).then(() => {
    document.getElementById('copyBtn').innerHTML = '<i class="fas fa-check"></i> Copied!';
    setTimeout(() => { document.getElementById('copyBtn').innerHTML = '<i class="fas fa-copy"></i> Copy'; }, 2000);
  });
});

// Close rulebook on tap outside
document.addEventListener('click', (e) => {
  const rb = document.getElementById('rulebook');
  const rt = document.getElementById('ruleToggle');
  if (rb.classList.contains('open') && !rb.contains(e.target) && !rt.contains(e.target)) {
    rb.classList.remove('open');
  }
});
</script>
</body>
</html>
