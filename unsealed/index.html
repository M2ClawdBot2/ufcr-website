<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UNSEALED â€” Daily Epstein Files Game | UFCR</title>
  <meta name="description" content="UNSEALED: A daily word game based on the publicly released Epstein court documents. Guess the redacted words.">
  <link rel="icon" href="../assets/images/shield-logo.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Oswald:wght@500;600;700&family=Special+Elite&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
  <style>
    :root {
      --blue: #0021A5;
      --orange: #FA4616;
      --gold: #F0A830;
      --white: #FFFFFF;
      --navy: #001845;
      --dark: #0A0E1A;
      --gray-100: #F5F5F7;
      --gray-600: #86868B;
      --gray-900: #1D1D1F;
      --font-body: 'Inter', -apple-system, sans-serif;
      --font-heading: 'Oswald', 'Inter', sans-serif;
      --font-doc: 'Special Elite', 'Courier New', monospace;
      --ease: cubic-bezier(0.22, 1, 0.36, 1);
    }

    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    html { -webkit-font-smoothing: antialiased; font-size: 16px; }
    body {
      font-family: var(--font-body);
      background: var(--dark);
      color: var(--white);
      overflow-x: hidden;
      min-height: 100vh;
    }
    a { text-decoration: none; color: inherit; }

    /* ========== NAV ========== */
    .nav {
      position: fixed;
      top: 0; left: 0; right: 0;
      z-index: 100;
      height: 80px;
      background: rgba(0,24,69,0.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .nav-inner {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 24px;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .nav-logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .nav-logo img {
      height: 44px;
      background: white;
      padding: 2px;
    }
    .nav-logo span {
      font-family: var(--font-heading);
      font-size: 1.4rem;
      font-weight: 700;
      letter-spacing: 0.08em;
    }
    .nav-right {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .nav-back {
      font-family: var(--font-heading);
      font-size: 0.8rem;
      font-weight: 600;
      color: rgba(255,255,255,0.5);
      letter-spacing: 0.15em;
      text-transform: uppercase;
      transition: color 0.3s;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .nav-back:hover { color: var(--white); }
    .nav-icon-btn {
      background: none;
      border: none;
      color: rgba(255,255,255,0.5);
      font-size: 1.2rem;
      cursor: pointer;
      transition: color 0.3s;
      padding: 8px;
    }
    .nav-icon-btn:hover { color: var(--white); }

    /* ========== MAIN ========== */
    .main {
      padding: 120px 24px 60px;
      max-width: 760px;
      margin: 0 auto;
    }

    /* ========== HEADER ========== */
    .game-header {
      text-align: center;
      margin-bottom: 40px;
    }
    .stamp-container {
      position: relative;
      display: inline-block;
      margin-bottom: 16px;
    }
    .stamp {
      font-family: var(--font-heading);
      font-size: 3.5rem;
      font-weight: 700;
      letter-spacing: 0.15em;
      color: var(--orange);
      text-transform: uppercase;
      border: 4px solid var(--orange);
      padding: 8px 32px;
      display: inline-block;
      transform: rotate(-2deg);
      position: relative;
    }
    .stamp::after {
      content: '';
      position: absolute;
      inset: -2px;
      border: 2px solid var(--orange);
      opacity: 0.4;
    }
    .game-subtitle {
      font-family: var(--font-body);
      font-size: 0.85rem;
      color: var(--gray-600);
      letter-spacing: 0.1em;
      text-transform: uppercase;
      margin-top: 8px;
    }
    .puzzle-number {
      font-family: var(--font-heading);
      font-size: 1.1rem;
      color: var(--gold);
      letter-spacing: 0.08em;
      margin-top: 4px;
    }

    /* ========== DOCUMENT AREA ========== */
    .document-wrapper {
      position: relative;
      margin-bottom: 32px;
    }
    .document {
      background: #f4f0e8;
      color: #1a1a1a;
      padding: 40px 36px;
      font-family: var(--font-doc);
      font-size: 1.15rem;
      line-height: 2;
      position: relative;
      border: 1px solid #c9c2b0;
      box-shadow: 0 4px 30px rgba(0,0,0,0.4);
    }
    .document::before {
      content: 'CLASSIFIED DOCUMENT';
      position: absolute;
      top: 12px;
      left: 36px;
      font-family: var(--font-heading);
      font-size: 0.65rem;
      letter-spacing: 0.2em;
      color: #999;
      text-transform: uppercase;
    }
    .document::after {
      content: '';
      position: absolute;
      inset: 0;
      background: repeating-linear-gradient(
        0deg,
        transparent,
        transparent 31px,
        rgba(0,0,0,0.03) 31px,
        rgba(0,0,0,0.03) 32px
      );
      pointer-events: none;
    }
    .document-stamp {
      position: absolute;
      top: 20px;
      right: 30px;
      font-family: var(--font-heading);
      font-size: 0.7rem;
      letter-spacing: 0.15em;
      color: var(--orange);
      border: 2px solid var(--orange);
      padding: 2px 10px;
      transform: rotate(3deg);
      opacity: 0.7;
    }
    .doc-text {
      margin-top: 20px;
      position: relative;
      z-index: 1;
    }
    .redacted-slot {
      display: inline-block;
      min-width: 80px;
      height: 28px;
      background: #111;
      vertical-align: middle;
      position: relative;
      margin: 0 4px;
      cursor: pointer;
      transition: background 0.3s, box-shadow 0.3s;
    }
    .redacted-slot:hover {
      box-shadow: 0 0 0 2px var(--orange);
    }
    .redacted-slot.active {
      box-shadow: 0 0 0 2px var(--orange);
      background: #222;
    }
    .redacted-slot.correct {
      background: #1a5c2a;
      color: var(--white);
    }
    .redacted-slot.revealed {
      background: transparent;
      color: var(--orange);
      font-weight: 700;
      border-bottom: 2px solid var(--orange);
    }
    .redacted-slot .slot-label {
      position: absolute;
      top: -16px;
      left: 0;
      font-family: var(--font-body);
      font-size: 0.55rem;
      color: var(--orange);
      letter-spacing: 0.1em;
      text-transform: uppercase;
    }
    .redacted-slot .slot-text {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      font-family: var(--font-doc);
      font-size: 1rem;
      color: var(--white);
      padding: 0 8px;
    }
    .difficulty-badge {
      display: inline-block;
      font-family: var(--font-heading);
      font-size: 0.65rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      padding: 2px 10px;
      margin-top: 16px;
      position: relative;
      z-index: 1;
    }
    .difficulty-badge.easy { color: #4caf50; border: 1px solid #4caf50; }
    .difficulty-badge.medium { color: var(--gold); border: 1px solid var(--gold); }
    .difficulty-badge.hard { color: var(--orange); border: 1px solid var(--orange); }

    /* ========== INPUT AREA ========== */
    .input-area {
      margin-bottom: 32px;
    }
    .input-row {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }
    .guess-input {
      flex: 1;
      background: rgba(255,255,255,0.06);
      border: 2px solid rgba(255,255,255,0.1);
      color: var(--white);
      font-family: var(--font-body);
      font-size: 1rem;
      padding: 14px 18px;
      outline: none;
      transition: border-color 0.3s;
    }
    .guess-input:focus {
      border-color: var(--orange);
    }
    .guess-input::placeholder {
      color: rgba(255,255,255,0.25);
    }
    .submit-btn {
      background: var(--orange);
      color: var(--white);
      border: none;
      font-family: var(--font-heading);
      font-size: 1rem;
      font-weight: 600;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      padding: 14px 28px;
      cursor: pointer;
      transition: background 0.3s, transform 0.1s;
    }
    .submit-btn:hover { background: #e03a0e; }
    .submit-btn:active { transform: scale(0.97); }
    .submit-btn:disabled {
      background: rgba(255,255,255,0.1);
      color: rgba(255,255,255,0.3);
      cursor: not-allowed;
    }

    /* ========== ATTEMPTS ========== */
    .attempts-area {
      margin-bottom: 24px;
    }
    .attempts-label {
      font-family: var(--font-heading);
      font-size: 0.75rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--gray-600);
      margin-bottom: 10px;
    }
    .attempts-row {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .attempt-dot {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      border: 2px solid rgba(255,255,255,0.15);
      color: rgba(255,255,255,0.3);
    }
    .attempt-dot.used-correct {
      border-color: #4caf50;
      background: rgba(76,175,80,0.15);
      color: #4caf50;
    }
    .attempt-dot.used-wrong {
      border-color: #f44336;
      background: rgba(244,67,54,0.15);
      color: #f44336;
    }

    /* ========== GUESS HISTORY ========== */
    .history {
      margin-bottom: 32px;
    }
    .history-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      font-size: 0.9rem;
    }
    .history-icon {
      width: 24px;
      text-align: center;
    }
    .history-icon.correct { color: #4caf50; }
    .history-icon.wrong { color: #f44336; }
    .history-word {
      font-family: var(--font-doc);
    }
    .history-target {
      color: var(--gray-600);
      font-size: 0.8rem;
    }

    /* ========== RESULT / POST-GAME ========== */
    .result-area {
      text-align: center;
      padding: 32px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.06);
      margin-bottom: 32px;
      display: none;
    }
    .result-area.show { display: block; }
    .result-title {
      font-family: var(--font-heading);
      font-size: 1.8rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      margin-bottom: 8px;
    }
    .result-title.win { color: #4caf50; }
    .result-title.lose { color: #f44336; }
    .result-sub {
      color: var(--gray-600);
      font-size: 0.9rem;
      margin-bottom: 20px;
    }
    .source-box {
      background: rgba(0,0,0,0.3);
      padding: 16px 20px;
      text-align: left;
      margin-bottom: 20px;
    }
    .source-label {
      font-family: var(--font-heading);
      font-size: 0.65rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--gold);
      margin-bottom: 6px;
    }
    .source-text {
      font-size: 0.85rem;
      color: rgba(255,255,255,0.7);
      line-height: 1.5;
    }
    .share-btn {
      background: var(--navy);
      color: var(--white);
      border: 2px solid var(--orange);
      font-family: var(--font-heading);
      font-size: 0.9rem;
      font-weight: 600;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      padding: 12px 28px;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }
    .share-btn:hover {
      background: var(--orange);
    }
    .share-copied {
      color: #4caf50;
      font-size: 0.8rem;
      margin-top: 8px;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .share-copied.show { opacity: 1; }

    /* ========== COUNTDOWN ========== */
    .countdown {
      text-align: center;
      margin-bottom: 32px;
    }
    .countdown-label {
      font-family: var(--font-heading);
      font-size: 0.7rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--gray-600);
      margin-bottom: 8px;
    }
    .countdown-time {
      font-family: var(--font-heading);
      font-size: 2rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      color: var(--gold);
    }

    /* ========== STATS AREA ========== */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 32px;
    }
    .stat-box {
      text-align: center;
      padding: 16px 8px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.06);
    }
    .stat-num {
      font-family: var(--font-heading);
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--white);
    }
    .stat-label {
      font-family: var(--font-heading);
      font-size: 0.6rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--gray-600);
      margin-top: 4px;
    }

    /* ========== MODAL ========== */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      z-index: 200;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }
    .modal-overlay.show { display: flex; }
    .modal {
      background: var(--dark);
      border: 1px solid rgba(255,255,255,0.1);
      max-width: 480px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      padding: 32px;
    }
    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }
    .modal-title {
      font-family: var(--font-heading);
      font-size: 1.4rem;
      font-weight: 700;
      letter-spacing: 0.08em;
    }
    .modal-close {
      background: none;
      border: none;
      color: var(--gray-600);
      font-size: 1.3rem;
      cursor: pointer;
      padding: 4px;
      transition: color 0.3s;
    }
    .modal-close:hover { color: var(--white); }

    /* ========== HOW TO PLAY ========== */
    .how-list {
      list-style: none;
      padding: 0;
    }
    .how-list li {
      display: flex;
      gap: 14px;
      align-items: flex-start;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      font-size: 0.9rem;
      color: rgba(255,255,255,0.7);
      line-height: 1.5;
    }
    .how-list li i {
      color: var(--orange);
      margin-top: 3px;
      width: 16px;
      text-align: center;
    }

    /* ========== FOOTER ========== */
    .game-footer {
      text-align: center;
      padding: 40px 24px;
      border-top: 1px solid rgba(255,255,255,0.06);
      margin-top: 40px;
    }
    .game-footer p {
      font-size: 0.75rem;
      color: var(--gray-600);
      line-height: 1.6;
    }
    .game-footer a {
      color: var(--orange);
      transition: color 0.3s;
    }
    .game-footer a:hover { color: var(--gold); }

    /* ========== RESPONSIVE ========== */
    @media (max-width: 600px) {
      .stamp { font-size: 2.2rem; padding: 6px 20px; }
      .document { padding: 30px 20px; font-size: 1rem; }
      .document::before { left: 20px; }
      .document-stamp { right: 16px; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .input-row { flex-direction: column; }
      .main { padding: 100px 16px 40px; }
    }

    /* ========== LOADING ========== */
    .loading {
      text-align: center;
      padding: 80px 24px;
    }
    .loading i {
      font-size: 2rem;
      color: var(--orange);
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <!-- NAV -->
  <nav class="nav">
    <div class="nav-inner">
      <a href="../" class="nav-logo">
        <img src="../assets/images/shield-logo.png" alt="UFCR">
        <span>UFCR</span>
      </a>
      <div class="nav-right">
        <button class="nav-icon-btn" id="helpBtn" title="How to Play"><i class="fas fa-question-circle"></i></button>
        <button class="nav-icon-btn" id="statsBtn" title="Statistics"><i class="fas fa-chart-bar"></i></button>
        <a href="../" class="nav-back">
          <i class="fas fa-arrow-left"></i> Back to Site
        </a>
      </div>
    </div>
  </nav>

  <!-- MAIN CONTENT -->
  <div class="main" id="gameContainer">
    <div class="loading" id="loadingState">
      <i class="fas fa-circle-notch"></i>
      <p style="margin-top:16px;color:var(--gray-600);font-size:0.85rem;">ACCESSING CLASSIFIED FILES...</p>
    </div>
  </div>

  <!-- HOW TO PLAY MODAL -->
  <div class="modal-overlay" id="helpModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">HOW TO PLAY</div>
        <button class="modal-close" id="helpClose"><i class="fas fa-times"></i></button>
      </div>
      <ul class="how-list">
        <li><i class="fas fa-file-alt"></i> Each day, a real fact from the Epstein court documents is shown with 3 key words redacted.</li>
        <li><i class="fas fa-keyboard"></i> Click a redacted bar to select it, then type your guess and submit.</li>
        <li><i class="fas fa-bullseye"></i> You have 5 total attempts to guess all 3 words. Case doesn't matter.</li>
        <li><i class="fas fa-check-circle"></i> Correct guesses are revealed in the document. Fill all 3 to win.</li>
        <li><i class="fas fa-share-alt"></i> Share your results without spoiling the answers.</li>
        <li><i class="fas fa-clock"></i> A new puzzle drops every day at midnight EST.</li>
      </ul>
    </div>
  </div>

  <!-- STATS MODAL -->
  <div class="modal-overlay" id="statsModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">STATISTICS</div>
        <button class="modal-close" id="statsClose"><i class="fas fa-times"></i></button>
      </div>
      <div class="stats-grid" id="statsGrid">
        <div class="stat-box"><div class="stat-num" id="statPlayed">0</div><div class="stat-label">Played</div></div>
        <div class="stat-box"><div class="stat-num" id="statWin">0</div><div class="stat-label">Win %</div></div>
        <div class="stat-box"><div class="stat-num" id="statStreak">0</div><div class="stat-label">Streak</div></div>
        <div class="stat-box"><div class="stat-num" id="statMax">0</div><div class="stat-label">Max Streak</div></div>
      </div>
    </div>
  </div>

  <script>
    (function() {
      'use strict';

      const STORAGE_KEY = 'unsealed_state';
      const STATS_KEY = 'unsealed_stats';
      const MAX_ATTEMPTS = 5;

      // State
      let entries = [];
      let todayEntry = null;
      let gameState = null; // { puzzleId, guesses: [{word, slotIndex, correct}], solved: [bool,bool,bool], finished: bool }
      let activeSlot = 0;

      // Get today's date in EST
      function getTodayEST() {
        const now = new Date();
        const est = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));
        const y = est.getFullYear();
        const m = String(est.getMonth() + 1).padStart(2, '0');
        const d = String(est.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
      }

      // Get next midnight EST in ms
      function getNextMidnightEST() {
        const now = new Date();
        const estStr = now.toLocaleString('en-US', { timeZone: 'America/New_York' });
        const estNow = new Date(estStr);
        const tomorrow = new Date(estNow);
        tomorrow.setDate(tomorrow.getDate() + 1);
        tomorrow.setHours(0, 0, 0, 0);
        const diff = tomorrow - estNow;
        return Date.now() + diff;
      }

      // Load stats
      function loadStats() {
        try { return JSON.parse(localStorage.getItem(STATS_KEY)) || { played: 0, wins: 0, streak: 0, maxStreak: 0 }; }
        catch { return { played: 0, wins: 0, streak: 0, maxStreak: 0 }; }
      }
      function saveStats(s) { localStorage.setItem(STATS_KEY, JSON.stringify(s)); }
      function updateStatsUI() {
        const s = loadStats();
        document.getElementById('statPlayed').textContent = s.played;
        document.getElementById('statWin').textContent = s.played ? Math.round((s.wins / s.played) * 100) : 0;
        document.getElementById('statStreak').textContent = s.streak;
        document.getElementById('statMax').textContent = s.maxStreak;
      }

      // Load/save game state
      function loadGameState() {
        try { return JSON.parse(localStorage.getItem(STORAGE_KEY)); } catch { return null; }
      }
      function saveGameState() { localStorage.setItem(STORAGE_KEY, JSON.stringify(gameState)); }

      // Find today's puzzle
      function findTodayPuzzle() {
        const today = getTodayEST();
        // First try exact date match
        let entry = entries.find(e => e.date === today);
        if (entry) return entry;
        // Fallback: cycle through entries based on day count from first entry
        const firstDate = new Date(entries[0].date);
        const todayDate = new Date(today);
        const daysDiff = Math.floor((todayDate - firstDate) / (1000 * 60 * 60 * 24));
        const idx = ((daysDiff % entries.length) + entries.length) % entries.length;
        return entries[idx];
      }

      // Build the game UI
      function buildGame() {
        const container = document.getElementById('gameContainer');
        const puzzleNum = todayEntry.id;

        // Initialize or restore state
        const saved = loadGameState();
        if (saved && saved.puzzleId === todayEntry.id) {
          gameState = saved;
        } else {
          gameState = {
            puzzleId: todayEntry.id,
            guesses: [],
            solved: [false, false, false],
            finished: false
          };
          saveGameState();
        }

        // Build text with redacted slots
        let docHTML = todayEntry.text;
        const redacted = todayEntry.redacted;
        // Replace each redacted word in the text with a slot
        for (let i = 0; i < redacted.length; i++) {
          const word = redacted[i];
          // Escape for regex
          const escaped = word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          const regex = new RegExp('\\b' + escaped + '\\b', 'i');
          const isSolved = gameState.solved[i];
          if (isSolved) {
            docHTML = docHTML.replace(regex, `<span class="redacted-slot revealed" data-slot="${i}"><span class="slot-label">${i + 1}</span><span class="slot-text">${word}</span></span>`);
          } else {
            docHTML = docHTML.replace(regex, `<span class="redacted-slot" data-slot="${i}" tabindex="0"><span class="slot-label">${i + 1}</span><span class="slot-text"></span></span>`);
          }
        }

        const attemptsUsed = gameState.guesses.length;
        const allSolved = gameState.solved.every(Boolean);
        const isFinished = gameState.finished;

        let html = `
          <div class="game-header">
            <div class="stamp-container">
              <div class="stamp" id="stampEl">UNSEALED</div>
            </div>
            <div class="game-subtitle">Daily Epstein Files Puzzle</div>
            <div class="puzzle-number"><i class="fas fa-hashtag"></i> ${puzzleNum}</div>
          </div>

          <div class="document-wrapper">
            <div class="document" id="documentEl">
              <div class="document-stamp">UNSEALED</div>
              <div class="doc-text" id="docText">${docHTML}</div>
              <div class="difficulty-badge ${todayEntry.difficulty}">${todayEntry.difficulty}</div>
            </div>
          </div>

          ${!isFinished ? `
          <div class="input-area" id="inputArea">
            <div class="input-row">
              <input type="text" class="guess-input" id="guessInput" placeholder="Type your guess for redacted word..." autocomplete="off" autocapitalize="off" spellcheck="false">
              <button class="submit-btn" id="submitBtn">GUESS</button>
            </div>
            <div style="font-size:0.75rem;color:var(--gray-600);margin-top:-8px;">
              <i class="fas fa-hand-pointer" style="color:var(--orange);margin-right:6px;"></i>
              Click a redacted bar to select which word to guess
            </div>
          </div>
          ` : ''}

          <div class="attempts-area">
            <div class="attempts-label">Attempts (${attemptsUsed}/${MAX_ATTEMPTS})</div>
            <div class="attempts-row" id="attemptsRow">
              ${Array.from({length: MAX_ATTEMPTS}, (_, i) => {
                if (i < gameState.guesses.length) {
                  const g = gameState.guesses[i];
                  return `<div class="attempt-dot ${g.correct ? 'used-correct' : 'used-wrong'}"><i class="fas fa-${g.correct ? 'check' : 'times'}"></i></div>`;
                }
                return `<div class="attempt-dot"><i class="fas fa-circle" style="font-size:0.4rem;"></i></div>`;
              }).join('')}
            </div>
          </div>

          ${gameState.guesses.length > 0 ? `
          <div class="history" id="historyArea">
            ${gameState.guesses.map(g => `
              <div class="history-item">
                <div class="history-icon ${g.correct ? 'correct' : 'wrong'}"><i class="fas fa-${g.correct ? 'check' : 'times'}"></i></div>
                <div class="history-word">${g.word}</div>
                <div class="history-target"><i class="fas fa-arrow-right" style="margin-right:4px;font-size:0.6rem;"></i> Slot ${g.slotIndex + 1}</div>
              </div>
            `).join('')}
          </div>
          ` : ''}

          <div class="result-area ${isFinished ? 'show' : ''}" id="resultArea">
            <div class="result-title ${allSolved ? 'win' : (isFinished ? 'lose' : '')}">
              ${allSolved ? '<i class="fas fa-stamp"></i> DECLASSIFIED' : (isFinished ? '<i class="fas fa-lock"></i> STILL CLASSIFIED' : '')}
            </div>
            <div class="result-sub">
              ${allSolved ? `You unsealed all 3 words in ${attemptsUsed} attempt${attemptsUsed !== 1 ? 's' : ''}!` : (isFinished ? `The answers were: ${redacted.join(', ')}` : '')}
            </div>
            ${isFinished ? `
            <div class="source-box">
              <div class="source-label"><i class="fas fa-bookmark" style="margin-right:6px;"></i> Source</div>
              <div class="source-text">${todayEntry.source}</div>
            </div>
            <div class="source-box">
              <div class="source-label"><i class="fas fa-info-circle" style="margin-right:6px;"></i> Context</div>
              <div class="source-text">${todayEntry.context}</div>
            </div>
            <button class="share-btn" id="shareBtn"><i class="fas fa-share-alt"></i> Share Results</button>
            <div class="share-copied" id="shareCopied"><i class="fas fa-check"></i> Copied to clipboard</div>
            ` : ''}
          </div>

          ${isFinished ? `
          <div class="countdown" id="countdownArea">
            <div class="countdown-label">Next puzzle in</div>
            <div class="countdown-time" id="countdownTime">--:--:--</div>
          </div>
          ` : ''}
        `;

        container.innerHTML = html;

        // Animate stamp
        gsap.from('#stampEl', { scale: 1.5, rotation: -10, opacity: 0, duration: 0.6, ease: 'back.out(1.7)' });
        gsap.from('#documentEl', { y: 30, opacity: 0, duration: 0.5, delay: 0.2 });

        // Bind events
        if (!isFinished) {
          bindGameEvents();
        }
        if (isFinished) {
          bindPostGameEvents();
          startCountdown();
        }

        // Set first unsolved slot active
        if (!isFinished) {
          const firstUnsolved = gameState.solved.indexOf(false);
          if (firstUnsolved >= 0) setActiveSlot(firstUnsolved);
        }
      }

      function setActiveSlot(idx) {
        activeSlot = idx;
        document.querySelectorAll('.redacted-slot').forEach(el => el.classList.remove('active'));
        const target = document.querySelector(`.redacted-slot[data-slot="${idx}"]`);
        if (target && !gameState.solved[idx]) {
          target.classList.add('active');
        }
        const input = document.getElementById('guessInput');
        if (input) input.placeholder = `Guess word #${idx + 1}...`;
      }

      function bindGameEvents() {
        // Slot clicking
        document.querySelectorAll('.redacted-slot').forEach(el => {
          el.addEventListener('click', () => {
            const idx = parseInt(el.dataset.slot);
            if (!gameState.solved[idx]) setActiveSlot(idx);
          });
        });

        const input = document.getElementById('guessInput');
        const btn = document.getElementById('submitBtn');

        btn.addEventListener('click', submitGuess);
        input.addEventListener('keydown', e => {
          if (e.key === 'Enter') submitGuess();
        });
      }

      function submitGuess() {
        const input = document.getElementById('guessInput');
        const guess = input.value.trim();
        if (!guess || gameState.finished) return;

        const answer = todayEntry.redacted[activeSlot];
        const correct = guess.toLowerCase() === answer.toLowerCase();

        gameState.guesses.push({ word: guess, slotIndex: activeSlot, correct });

        if (correct) {
          gameState.solved[activeSlot] = true;
        }

        const allSolved = gameState.solved.every(Boolean);
        const outOfAttempts = gameState.guesses.length >= MAX_ATTEMPTS;

        if (allSolved || outOfAttempts) {
          gameState.finished = true;
          // Update stats
          const stats = loadStats();
          stats.played++;
          if (allSolved) {
            stats.wins++;
            stats.streak++;
            if (stats.streak > stats.maxStreak) stats.maxStreak = stats.streak;
          } else {
            stats.streak = 0;
          }
          saveStats(stats);
        }

        saveGameState();
        buildGame();
        updateStatsUI();

        // Focus input if game continues
        if (!gameState.finished) {
          setTimeout(() => {
            const inp = document.getElementById('guessInput');
            if (inp) inp.focus();
          }, 100);
        }
      }

      function bindPostGameEvents() {
        const shareBtn = document.getElementById('shareBtn');
        if (shareBtn) {
          shareBtn.addEventListener('click', () => {
            const puzzleNum = todayEntry.id;
            const guessCount = gameState.guesses.length;
            const squares = gameState.guesses.map(g => g.correct ? '\u{1F7E9}' : '\u{1F7E5}').join('');
            const text = `UNSEALED #${puzzleNum} ${squares} ${guessCount}/${MAX_ATTEMPTS}\nufcr.online/unsealed/`;

            if (navigator.clipboard) {
              navigator.clipboard.writeText(text).then(() => {
                document.getElementById('shareCopied').classList.add('show');
                setTimeout(() => document.getElementById('shareCopied').classList.remove('show'), 2000);
              });
            } else {
              // Fallback
              const ta = document.createElement('textarea');
              ta.value = text;
              document.body.appendChild(ta);
              ta.select();
              document.execCommand('copy');
              document.body.removeChild(ta);
              document.getElementById('shareCopied').classList.add('show');
              setTimeout(() => document.getElementById('shareCopied').classList.remove('show'), 2000);
            }
          });
        }
      }

      function startCountdown() {
        const el = document.getElementById('countdownTime');
        if (!el) return;
        const targetMs = getNextMidnightEST();

        function tick() {
          const diff = targetMs - Date.now();
          if (diff <= 0) {
            el.textContent = '00:00:00';
            setTimeout(() => location.reload(), 1000);
            return;
          }
          const h = String(Math.floor(diff / 3600000)).padStart(2, '0');
          const m = String(Math.floor((diff % 3600000) / 60000)).padStart(2, '0');
          const s = String(Math.floor((diff % 60000) / 1000)).padStart(2, '0');
          el.textContent = `${h}:${m}:${s}`;
          requestAnimationFrame(tick);
        }
        tick();
      }

      // Modal handlers
      function setupModals() {
        document.getElementById('helpBtn').addEventListener('click', () => document.getElementById('helpModal').classList.add('show'));
        document.getElementById('helpClose').addEventListener('click', () => document.getElementById('helpModal').classList.remove('show'));
        document.getElementById('statsBtn').addEventListener('click', () => { updateStatsUI(); document.getElementById('statsModal').classList.add('show'); });
        document.getElementById('statsClose').addEventListener('click', () => document.getElementById('statsModal').classList.remove('show'));

        [document.getElementById('helpModal'), document.getElementById('statsModal')].forEach(m => {
          m.addEventListener('click', e => { if (e.target === m) m.classList.remove('show'); });
        });
      }

      // Init
      async function init() {
        setupModals();
        try {
          const resp = await fetch('./entries.json');
          entries = await resp.json();
          todayEntry = findTodayPuzzle();
          buildGame();
          updateStatsUI();

          // Show help on first visit
          if (!localStorage.getItem('unsealed_visited')) {
            localStorage.setItem('unsealed_visited', '1');
            document.getElementById('helpModal').classList.add('show');
          }
        } catch (err) {
          document.getElementById('gameContainer').innerHTML = `
            <div style="text-align:center;padding:80px 24px;">
              <i class="fas fa-exclamation-triangle" style="font-size:2rem;color:var(--orange);"></i>
              <p style="margin-top:16px;color:var(--gray-600);">Failed to load puzzle data.</p>
            </div>`;
        }
      }

      init();
    })();
  </script>
</body>
</html>
